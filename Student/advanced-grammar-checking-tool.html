<div class="separator" style="clear: both;"><a href="https://cdn-icons-png.flaticon.com/128/19009/19009240.png" style="display: block; padding: 1em 0px; text-align: center;"><img alt="" border="0" data-original-height="128" data-original-width="128" src="https://cdn-icons-png.flaticon.com/128/19009/19009240.png" style="display: none;" width="200" /></a></div>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Grammar Checking Tool</title>
    <style>
        /* CSS Styles */
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #34a853;
            --error-color: #ea4335;
            --warning-color: #fbbc05;
            --info-color: #4285f4;
            --dark-color: #202124;
            --light-color: #f8f9fa;
            --gray-color: #dadce0;
            --success-color: #0f9d58;
            --accent-color: #673ab7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 1.5rem 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .main-title {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .tool-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
        }

        .editor-section, .results-section {
            flex: 1;
            min-width: 300px;
        }

        .text-editor {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            height: 100%;
        }

        #text-input {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid var(--gray-color);
            border-radius: 4px;
            resize: vertical;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        #text-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.2);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1e3d72;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #2d9249;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .stats-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-box {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
            flex: 1;
            min-width: 120px;
            transition: transform 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .results-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            height: 100%;
            max-height: 600px;
            overflow-y: auto;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-color);
        }

        .results-title {
            font-size: 1.3rem;
            color: var(--dark-color);
        }

        .error-list {
            list-style-type: none;
        }

        .error-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: #f9f9f9;
            border-left: 4px solid var(--error-color);
            transition: transform 0.2s;
        }

        .error-item:hover {
            transform: translateX(5px);
        }

        .error-item.warning {
            border-left-color: var(--warning-color);
        }
        
        .error-item.info {
            border-left-color: var(--info-color);
        }

        .error-item.success {
            border-left-color: var(--success-color);
        }

        .error-type {
            font-weight: bold;
            color: var(--error-color);
            margin-bottom: 5px;
        }

        .error-item.warning .error-type {
            color: var(--warning-color);
        }
        
        .error-item.info .error-type {
            color: var(--info-color);
        }

        .error-item.success .error-type {
            color: var(--success-color);
        }

        .error-context {
            font-style: italic;
            color: #666;
            margin: 5px 0;
        }

        .error-suggestion {
            color: var(--secondary-color);
            font-weight: 500;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        footer {
            text-align: center;
            padding: 20px;
            background-color: var(--dark-color);
            color: white;
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            .tool-container {
                flex-direction: column;
            }
            
            .main-title {
                font-size: 2rem;
            }
        }

        /* Advanced features toggle */
        .advanced-options {
            margin: 20px 0;
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 8px;
        }

        .toggle-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .toggle-icon {
            margin-right: 10px;
            transition: transform 0.3s ease;
        }

        .toggle-icon.rotated {
            transform: rotate(90deg);
        }

        .options-content {
            margin-top: 15px;
            display: none;
        }

        .options-content.show {
            display: block;
        }

        .checkbox-group {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }

        .checkbox-group input {
            margin-right: 8px;
        }

        .readability-score {
            margin-top: 20px;
            padding: 15px;
            background-color: #e6f4ea;
            border-radius: 8px;
        }
        
        .score-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .score-explanation {
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .enhancement-suggestions {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f0fe;
            border-radius: 8px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .dashboard-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .dashboard-label {
            font-size: 0.9rem;
            color: #666;
        }

        .confidence-meter {
            height: 6px;
            background-color: #eee;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .confidence-high {
            background-color: var(--success-color);
        }

        .confidence-medium {
            background-color: var(--warning-color);
        }

        .confidence-low {
            background-color: var(--error-color);
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-color);
        }

        .status-indicator.offline {
            background-color: var(--error-color);
        }

        .tone-analysis {
            margin-top: 20px;
            padding: 15px;
            background-color: #f3e5f5;
            border-radius: 8px;
        }

        .tone-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tone-tag {
            background-color: var(--accent-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .improvement-score {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            background: conic-gradient(var(--secondary-color) 0% var(--p, 0%), #eee var(--p, 0%) 100%);
            position: relative;
        }

        .score-circle::before {
            content: '';
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
        }

        .score-circle span {
            z-index: 1;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .export-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: #f1f3f4;
            color: var(--dark-color);
        }

        .export-btn:hover {
            background-color: #e8eaed;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1 class="main-title">Professional Grammar Checking Tool</h1>
            <p class="subtitle">AI-powered grammar, spelling, and style analysis with DeepSeek API</p>
        </div>
    </header>

    <div class="container">
        <div class="dashboard">
            <div class="dashboard-card">
                <div class="dashboard-value" id="word-count">0</div>
                <div class="dashboard-label">Words</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-value" id="char-count">0</div>
                <div class="dashboard-label">Characters</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-value" id="error-count">0</div>
                <div class="dashboard-label">Issues</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-value" id="confidence-score">-</div>
                <div class="dashboard-label">Confidence</div>
                <div class="confidence-meter">
                    <div class="confidence-fill" id="confidence-fill"></div>
                </div>
            </div>
        </div>

        <div class="tool-container">
            <section class="editor-section">
                <div class="text-editor">
                    <h2>Enter Your Text</h2>
                    <textarea id="text-input" placeholder="Type or paste your text here to check for grammar, spelling, and style issues..."></textarea>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="check-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Check Grammar
                        </button>
                        <button class="btn btn-outline" id="clear-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Clear Text
                        </button>
                    </div>

                    <div class="advanced-options">
                        <div class="toggle-header" onclick="toggleAdvancedOptions()">
                            <span class="toggle-icon">▶</span>
                            <h3>Advanced Options</h3>
                        </div>
                        <div class="options-content" id="advanced-options-content">
                            <div class="checkbox-group">
                                <input checked id="check-spelling" type="checkbox">
                                <label for="check-spelling">Check Spelling</label>
                            </div>
                            <div class="checkbox-group">
                                <input checked id="check-grammar" type="checkbox">
                                <label for="check-grammar">Check Grammar</label>
                            </div>
                            <div class="checkbox-group">
                                <input checked id="check-punctuation" type="checkbox">
                                <label for="check-punctuation">Check Punctuation</label>
                            </div>
                            <div class="checkbox-group">
                                <input id="check-style" type="checkbox">
                                <label for="check-style">Check Style (Formal/Informal)</label>
                            </div>
                            <div class="checkbox-group">
                                <input id="check-repetition" type="checkbox">
                                <label for="check-repetition">Check Word Repetition</label>
                            </div>
                            <div class="checkbox-group">
                                <input id="check-readability" type="checkbox" checked>
                                <label for="check-readability">Calculate Readability Score</label>
                            </div>
                            <div class="checkbox-group">
                                <input id="check-vocabulary" type="checkbox">
                                <label for="check-vocabulary">Vocabulary Enhancement</label>
                            </div>
                            <div class="checkbox-group">
                                <input id="check-tone" type="checkbox">
                                <label for="check-tone">Tone Analysis</label>
                            </div>
                        </div>
                    </div>

                    <div class="api-status">
                        <div class="status-indicator" id="api-status"></div>
                        <span id="api-status-text">API Status: Checking...</span>
                    </div>
                </div>
            </section>

            <section class="results-section">
                <div class="results-container">
                    <div class="results-header">
                        <h2 class="results-title">Grammar Check Results</h2>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" id="download-report">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15M7 10L12 15M12 15L17 10M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Download Report
                            </button>
                        </div>
                    </div>

                    <div id="initial-state">
                        <p>Your grammar check results will appear here. Click "Check Grammar" to analyze your text.</p>
                    </div>

                    <div class="hidden" id="loading-state">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Analyzing your text with AI...</p>
                        </div>
                    </div>

                    <div class="hidden" id="results-state">
                        <div class="improvement-score">
                            <div class="score-circle" id="improvement-circle">
                                <span id="improvement-value">0%</span>
                            </div>
                            <div>
                                <h3>Writing Quality</h3>
                                <p>Based on grammar, style, and readability analysis</p>
                            </div>
                        </div>

                        <div class="readability-score hidden" id="readability-score">
                            <h3>Readability Score</h3>
                            <div class="score-value" id="score-value">0</div>
                            <div class="score-explanation" id="score-explanation"></div>
                        </div>
                        
                        <div class="tone-analysis hidden" id="tone-analysis">
                            <h3>Tone Analysis</h3>
                            <div class="tone-tags" id="tone-tags">
                                <!-- Tone tags will be populated here -->
                            </div>
                        </div>
                        
                        <div class="enhancement-suggestions hidden" id="enhancement-suggestions">
                            <h3>Vocabulary Enhancements</h3>
                            <ul id="enhancement-list"></ul>
                        </div>
                        
                        <h3 style="margin: 20px 0 10px 0;">Issues Found</h3>
                        <ul class="error-list" id="error-list">
                            <!-- Errors will be populated here by JavaScript -->
                        </ul>

                        <div class="export-options">
                            <button class="export-btn" id="export-txt">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8M14 2L20 8M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Export as TXT
                            </button>
                            <button class="export-btn" id="export-html">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8M14 2L20 8M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Export as HTML
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>© 2023 Professional Grammar Checking Tool. Powered by DeepSeek AI.</p>
        </div>
    </footer>

    <script>
        // Professional Grammar Checker with DeepSeek API
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const textInput = document.getElementById('text-input');
            const checkBtn = document.getElementById('check-btn');
            const clearBtn = document.getElementById('clear-btn');
            const wordCountEl = document.getElementById('word-count');
            const charCountEl = document.getElementById('char-count');
            const errorCountEl = document.getElementById('error-count');
            const confidenceScoreEl = document.getElementById('confidence-score');
            const confidenceFillEl = document.getElementById('confidence-fill');
            const errorList = document.getElementById('error-list');
            const initialState = document.getElementById('initial-state');
            const loadingState = document.getElementById('loading-state');
            const resultsState = document.getElementById('results-state');
            const downloadReportBtn = document.getElementById('download-report');
            const readabilityScore = document.getElementById('readability-score');
            const scoreValue = document.getElementById('score-value');
            const scoreExplanation = document.getElementById('score-explanation');
            const enhancementSuggestions = document.getElementById('enhancement-suggestions');
            const enhancementList = document.getElementById('enhancement-list');
            const toneAnalysis = document.getElementById('tone-analysis');
            const toneTags = document.getElementById('tone-tags');
            const improvementCircle = document.getElementById('improvement-circle');
            const improvementValue = document.getElementById('improvement-value');
            const apiStatusEl = document.getElementById('api-status');
            const apiStatusText = document.getElementById('api-status-text');
            const exportTxtBtn = document.getElementById('export-txt');
            const exportHtmlBtn = document.getElementById('export-html');

            // API Configuration
            const API_KEY = "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";
            const API_URL = "https://openrouter.ai/api/v1/chat/completions";

            // Counters
            let wordCount = 0;
            let charCount = 0;
            let errorCount = 0;

            // Initialize
            updateCounters();
            checkAPIStatus();

            // Event Listeners
            textInput.addEventListener('input', function() {
                updateCounters();
                resetResults();
            });

            checkBtn.addEventListener('click', checkGrammar);
            clearBtn.addEventListener('click', clearText);
            downloadReportBtn.addEventListener('click', downloadReport);
            exportTxtBtn.addEventListener('click', exportAsTxt);
            exportHtmlBtn.addEventListener('click', exportAsHtml);

            // Functions
            function updateCounters() {
                const text = textInput.value.trim();
                
                // Word count (split by whitespace and filter out empty strings)
                wordCount = text === '' ? 0 : text.split(/\s+/).length;
                wordCountEl.textContent = wordCount;
                
                // Character count (including spaces)
                charCount = text.length;
                charCountEl.textContent = charCount;
            }

            function resetResults() {
                initialState.classList.remove('hidden');
                loadingState.classList.add('hidden');
                resultsState.classList.add('hidden');
                readabilityScore.classList.add('hidden');
                enhancementSuggestions.classList.add('hidden');
                toneAnalysis.classList.add('hidden');
                errorCount = 0;
                errorCountEl.textContent = errorCount;
                downloadReportBtn.disabled = true;
                exportTxtBtn.disabled = true;
                exportHtmlBtn.disabled = true;
            }

            function clearText() {
                textInput.value = '';
                updateCounters();
                resetResults();
            }

            function toggleAdvancedOptions() {
                const content = document.getElementById('advanced-options-content');
                const icon = document.querySelector('.toggle-icon');
                content.classList.toggle('show');
                icon.classList.toggle('rotated');
            }

            async function checkAPIStatus() {
                try {
                    const response = await fetch('https://openrouter.ai/api/v1/models', {
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`
                        }
                    });
                    
                    if (response.ok) {
                        apiStatusEl.classList.remove('offline');
                        apiStatusText.textContent = 'API Status: Online';
                    } else {
                        throw new Error('API not available');
                    }
                } catch (error) {
                    apiStatusEl.classList.add('offline');
                    apiStatusText.textContent = 'API Status: Offline - Using fallback analysis';
                }
            }

            async function checkGrammar() {
                const text = textInput.value.trim();
                if (text === '') {
                    alert('Please enter some text to check.');
                    return;
                }

                // Show loading state
                initialState.classList.add('hidden');
                loadingState.classList.remove('hidden');
                resultsState.classList.add('hidden');
                readabilityScore.classList.add('hidden');
                enhancementSuggestions.classList.add('hidden');
                toneAnalysis.classList.add('hidden');

                try {
                    // Try to use DeepSeek API first
                    const aiResults = await checkWithDeepSeekAPI(text);
                    processGrammarCheck(text, aiResults);
                } catch (error) {
                    console.error('API Error:', error);
                    // Fallback to local analysis
                    processGrammarCheck(text);
                }
            }

            async function checkWithDeepSeekAPI(text) {
                const prompt = `
                Analyze the following text for grammar, spelling, punctuation, and style issues. 
                Provide a JSON response with the following structure:
                {
                    "issues": [
                        {
                            "type": "spelling|grammar|punctuation|style",
                            "message": "Description of the issue",
                            "context": "The sentence or phrase where the issue occurs",
                            "suggestion": "How to fix the issue",
                            "severity": "error|warning|info"
                        }
                    ],
                    "readability": {
                        "score": 0-100,
                        "explanation": "Brief explanation of readability level"
                    },
                    "tone": ["formal", "informal", "academic", "conversational", etc.],
                    "vocabularyEnhancements": [
                        {
                            "word": "informal word",
                            "suggestions": ["more formal alternative 1", "alternative 2"]
                        }
                    ],
                    "confidence": 0-100
                }
                
                Text to analyze: "${text}"
                `;

                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": "deepseek/deepseek-chat-v3.1:free",
                        "messages": [
                            {
                                "role": "user",
                                "content": prompt
                            }
                        ],
                        "temperature": 0.1,
                        "max_tokens": 2000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // Try to parse JSON from the response
                try {
                    return JSON.parse(content);
                } catch (e) {
                    // If JSON parsing fails, try to extract JSON from the response
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('Could not parse API response');
                    }
                }
            }

            function processGrammarCheck(text, aiResults = null) {
                // Hide loading state
                loadingState.classList.add('hidden');
                
                // Clear previous results
                errorList.innerHTML = '';
                enhancementList.innerHTML = '';
                toneTags.innerHTML = '';
                errorCount = 0;

                let issues = [];
                let readability = { score: 0, explanation: '' };
                let tone = [];
                let enhancements = [];
                let confidence = 0;

                if (aiResults) {
                    // Use AI results
                    issues = aiResults.issues || [];
                    readability = aiResults.readability || { score: 0, explanation: '' };
                    tone = aiResults.tone || [];
                    enhancements = aiResults.vocabularyEnhancements || [];
                    confidence = aiResults.confidence || 0;
                } else {
                    // Fallback to local analysis
                    issues = checkTextForIssues(text);
                    readability = calculateReadability(text);
                    enhancements = getVocabularyEnhancements(text);
                    confidence = Math.min(80, 100 - (issues.length * 2)); // Simple confidence calculation
                }

                // Update confidence display
                confidenceScoreEl.textContent = `${confidence}%`;
                confidenceFillEl.className = 'confidence-fill';
                confidenceFillEl.style.width = `${confidence}%`;
                
                if (confidence >= 70) {
                    confidenceFillEl.classList.add('confidence-high');
                } else if (confidence >= 40) {
                    confidenceFillEl.classList.add('confidence-medium');
                } else {
                    confidenceFillEl.classList.add('confidence-low');
                }

                // Calculate improvement score
                const improvementScore = Math.max(0, 100 - (issues.length * 5));
                improvementValue.textContent = `${improvementScore}%`;
                improvementCircle.style.setProperty('--p', `${improvementScore}%`);

                // Display readability if enabled
                if (document.getElementById('check-readability').checked) {
                    scoreValue.textContent = readability.score;
                    scoreExplanation.textContent = readability.explanation;
                    readabilityScore.classList.remove('hidden');
                }
                
                // Display tone analysis if enabled
                if (document.getElementById('check-tone').checked && tone.length > 0) {
                    tone.forEach(t => {
                        const tag = document.createElement('span');
                        tag.className = 'tone-tag';
                        tag.textContent = t;
                        toneTags.appendChild(tag);
                    });
                    toneAnalysis.classList.remove('hidden');
                }
                
                // Get enhancement suggestions if enabled
                if (document.getElementById('check-vocabulary').checked && enhancements.length > 0) {
                    enhancements.forEach(enhancement => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${enhancement.word}</strong> → Consider using: ${enhancement.suggestions.join(', ')}`;
                        enhancementList.appendChild(li);
                    });
                    enhancementSuggestions.classList.remove('hidden');
                }

                // Display issues
                if (issues.length > 0) {
                    issues.forEach(issue => {
                        addErrorToResults(issue);
                    });
                    resultsState.classList.remove('hidden');
                } else {
                    const p = document.createElement('p');
                    p.textContent = 'No grammar or spelling errors found. Great job!';
                    initialState.innerHTML = '';
                    initialState.appendChild(p);
                    initialState.classList.remove('hidden');
                }

                // Update error count
                errorCount = issues.length;
                errorCountEl.textContent = errorCount;
                
                // Enable download and export buttons
                downloadReportBtn.disabled = false;
                exportTxtBtn.disabled = false;
                exportHtmlBtn.disabled = false;
            }

            // Local fallback functions (same as before, but shortened for brevity)
            function checkTextForIssues(text) {
                const issues = [];
                const sentences = splitIntoSentences(text);
                
                // Check spelling if enabled
                if (document.getElementById('check-spelling').checked) {
                    issues.push(...checkSpelling(text));
                }
                
                // Check grammar if enabled
                if (document.getElementById('check-grammar').checked) {
                    issues.push(...checkGrammarRules(text));
                    sentences.forEach(sentence => {
                        issues.push(...checkSentenceStructure(sentence));
                    });
                }
                
                // Check punctuation if enabled
                if (document.getElementById('check-punctuation').checked) {
                    sentences.forEach(sentence => {
                        issues.push(...checkPunctuation(sentence));
                    });
                }
                
                // Check style if enabled
                if (document.getElementById('check-style').checked) {
                    issues.push(...checkStyle(text));
                }
                
                // Check repetition if enabled
                if (document.getElementById('check-repetition').checked) {
                    issues.push(...checkRepetition(text));
                }
                
                return issues;
            }

            function checkSpelling(text) {
                const issues = [];
                const words = text.toLowerCase().split(/\s+/);
                const commonMisspellings = {
                    'recieve': 'receive',
                    'seperate': 'separate',
                    'definately': 'definitely',
                    'occured': 'occurred',
                    'untill': 'until',
                    'wich': 'which',
                    'teh': 'the',
                    'adn': 'and',
                    'thier': 'their',
                    'alot': 'a lot'
                };
                
                words.forEach((word, index) => {
                    const cleanWord = word.replace(/[.,!?;:()"]/g, '');
                    if (commonMisspellings[cleanWord]) {
                        issues.push({
                            type: 'spelling',
                            message: `Possible misspelling: "${cleanWord}"`,
                            context: `...${words.slice(Math.max(0, index-2), Math.min(words.length, index+3)).join(' ')}...`,
                            suggestion: `Did you mean "${commonMisspellings[cleanWord]}"?`,
                            severity: 'error'
                        });
                    }
                });
                
                return issues;
            }

            function checkGrammarRules(text) {
                const issues = [];
                
                // Check for common grammar mistakes
                if (text.match(/\ba lot\b/i) && !text.match(/\balot\b/i)) {
                    // This is just an example - in reality, "a lot" is correct
                }
                
                // Check for subject-verb agreement in simple cases
                const sentences = splitIntoSentences(text);
                sentences.forEach(sentence => {
                    const words = sentence.split(/\s+/);
                    
                    // Simple check for "there is/are"
                    if (sentence.toLowerCase().includes('there is') && words.some(w => w.toLowerCase().match(/many|several|few|some|a few/))) {
                        issues.push({
                            type: 'grammar',
                            message: 'Possible subject-verb agreement issue',
                            context: sentence,
                            suggestion: 'Consider using "there are" instead of "there is" for plural subjects',
                            severity: 'warning'
                        });
                    }
                    
                    // Check for double negatives
                    if (sentence.match(/\b(?:not|no|never)\b.*\b(?:not|no|never)\b/i)) {
                        issues.push({
                            type: 'grammar',
                            message: 'Double negative detected',
                            context: sentence,
                            suggestion: 'Consider rephrasing to avoid double negatives',
                            severity: 'warning'
                        });
                    }
                });
                
                return issues;
            }

            function checkSentenceStructure(sentence) {
                const issues = [];
                
                // Check for run-on sentences
                if (sentence.split(/\s+/).length > 25) {
                    issues.push({
                        type: 'style',
                        message: 'Long sentence detected',
                        context: sentence,
                        suggestion: 'Consider breaking this long sentence into shorter ones for better readability',
                        severity: 'info'
                    });
                }
                
                // Check for sentence fragments
                if (sentence.split(/\s+/).length < 5 && !sentence.match(/[.!?]$/)) {
                    issues.push({
                        type: 'grammar',
                        message: 'Possible sentence fragment',
                        context: sentence,
                        suggestion: 'This might be an incomplete sentence. Consider expanding it or connecting it to another sentence',
                        severity: 'warning'
                    });
                }
                
                return issues;
            }

            function checkPunctuation(sentence) {
                const issues = [];
                
                // Check for missing commas in lists
                if (sentence.match(/\b\w+, \w+ and \w+\b/) && !sentence.match(/\b\w+, \w+, and \w+\b/)) {
                    issues.push({
                        type: 'punctuation',
                        message: 'Missing Oxford comma',
                        context: sentence,
                        suggestion: 'Consider adding a comma before "and" in lists (Oxford comma) for clarity',
                        severity: 'info'
                    });
                }
                
                // Check for missing question marks
                if (sentence.toLowerCase().startsWith('what') || 
                    sentence.toLowerCase().startsWith('how') || 
                    sentence.toLowerCase().startsWith('why') || 
                    sentence.toLowerCase().startsWith('when') || 
                    sentence.toLowerCase().startsWith('where') || 
                    sentence.toLowerCase().startsWith('who')) {
                    
                    if (!sentence.endsWith('?')) {
                        issues.push({
                            type: 'punctuation',
                            message: 'Question without question mark',
                            context: sentence,
                            suggestion: 'Add a question mark at the end of the sentence',
                            severity: 'error'
                        });
                    }
                }
                
                return issues;
            }

            function checkStyle(text) {
                const issues = [];
                
                // Check for informal language
                const informalWords = ['gonna', 'wanna', 'gotta', 'kinda', 'sorta', 'ain\'t'];
                informalWords.forEach(word => {
                    if (text.toLowerCase().includes(word)) {
                        issues.push({
                            type: 'style',
                            message: `Informal word: "${word}"`,
                            context: `...${text.substring(Math.max(0, text.toLowerCase().indexOf(word)-20), Math.min(text.length, text.toLowerCase().indexOf(word)+30))}...`,
                            suggestion: `Consider using a more formal alternative (e.g., "going to" instead of "gonna")`,
                            severity: 'info'
                        });
                    }
                });
                
                // Check for passive voice (simplified)
                if (text.match(/\b(is|are|was|were|be|been|being) [a-z]+ed\b/i)) {
                    issues.push({
                        type: 'style',
                        message: 'Possible passive voice',
                        context: text.substring(Math.max(0, text.search(/\b(is|are|was|were|be|been|being) [a-z]+ed\b/i)-20), 
                                  Math.min(text.length, text.search(/\b(is|are|was|were|be|been|being) [a-z]+ed\b/i)+30)),
                        suggestion: 'Consider using active voice for more direct and engaging writing',
                        severity: 'info'
                    });
                }
                
                return issues;
            }

            function checkRepetition(text) {
                const issues = [];
                const words = text.toLowerCase().split(/\s+/);
                const wordCounts = {};
                
                // Count word frequencies
                words.forEach(word => {
                    const cleanWord = word.replace(/[.,!?;:()"]/g, '');
                    if (cleanWord.length > 3) { // Only consider words longer than 3 characters
                        wordCounts[cleanWord] = (wordCounts[cleanWord] || 0) + 1;
                    }
                });
                
                // Flag words used too frequently
                Object.keys(wordCounts).forEach(word => {
                    if (wordCounts[word] > 3) { // Threshold for repetition
                        issues.push({
                            type: 'style',
                            message: `Word repetition: "${word}" used ${wordCounts[word]} times`,
                            context: `Consider using synonyms to vary your word choice`,
                            suggestion: `Try using alternatives for "${word}" to make your writing more engaging`,
                            severity: 'info'
                        });
                    }
                });
                
                return issues;
            }

            function calculateReadability(text) {
                // Simplified Flesch Reading Ease calculation
                const words = text.split(/\s+/).length;
                const sentences = splitIntoSentences(text).length;
                const syllables = countSyllables(text);
                
                if (words === 0 || sentences === 0) {
                    return { score: 0, explanation: 'Not enough text to calculate readability' };
                }
                
                const score = Math.max(0, Math.min(100, 206.835 - 1.015 * (words / sentences) - 84.6 * (syllables / words)));
                
                let explanation = '';
                if (score >= 90) explanation = 'Very easy to read';
                else if (score >= 80) explanation = 'Easy to read';
                else if (score >= 70) explanation = 'Fairly easy to read';
                else if (score >= 60) explanation = 'Standard reading level';
                else if (score >= 50) explanation = 'Fairly difficult to read';
                else if (score >= 30) explanation = 'Difficult to read';
                else explanation = 'Very difficult to read';
                
                return { score: Math.round(score), explanation };
            }

            function countSyllables(text) {
                // Simplified syllable counting
                let count = 0;
                const words = text.toLowerCase().split(/\s+/);
                
                words.forEach(word => {
                    const cleanWord = word.replace(/[.,!?;:()"]/g, '');
                    if (cleanWord.length <= 3) {
                        count += 1;
                    } else {
                        // Count vowel groups
                        const vowelGroups = cleanWord.match(/[aeiouy]+/g);
                        count += vowelGroups ? vowelGroups.length : 1;
                    }
                });
                
                return count;
            }

            function getVocabularyEnhancements(text) {
                const enhancements = [];
                const words = text.toLowerCase().split(/\s+/);
                
                // Simple vocabulary enhancement suggestions
                const basicWords = {
                    'good': ['excellent', 'outstanding', 'superb', 'remarkable'],
                    'bad': ['poor', 'inadequate', 'unsatisfactory', 'substandard'],
                    'big': ['large', 'substantial', 'considerable', 'significant'],
                    'small': ['tiny', 'minute', 'minuscule', 'compact'],
                    'important': ['crucial', 'vital', 'essential', 'paramount'],
                    'interesting': ['fascinating', 'captivating', 'intriguing', 'compelling']
                };
                
                words.forEach(word => {
                    const cleanWord = word.replace(/[.,!?;:()"]/g, '');
                    if (basicWords[cleanWord]) {
                        enhancements.push({
                            word: cleanWord,
                            suggestions: basicWords[cleanWord]
                        });
                    }
                });
                
                return enhancements;
            }

            function splitIntoSentences(text) {
                return text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            }

            function addErrorToResults(issue) {
                const li = document.createElement('li');
                li.className = `error-item ${issue.severity === 'warning' ? 'warning' : issue.severity === 'info' ? 'info' : ''}`;
                
                li.innerHTML = `
                    <div class="error-type">${issue.type.charAt(0).toUpperCase() + issue.type.slice(1)} ${issue.severity}</div>
                    <div class="error-message">${issue.message}</div>
                    <div class="error-context">${issue.context}</div>
                    <div class="error-suggestion">Suggestion: ${issue.suggestion}</div>
                `;
                
                errorList.appendChild(li);
            }

            function downloadReport() {
                const text = textInput.value;
                const issues = Array.from(errorList.querySelectorAll('.error-item')).map(item => ({
                    type: item.querySelector('.error-type').textContent,
                    message: item.querySelector('.error-message').textContent,
                    context: item.querySelector('.error-context').textContent,
                    suggestion: item.querySelector('.error-suggestion').textContent.replace('Suggestion: ', '')
                }));
                
                const report = `
GRAMMAR CHECK REPORT
====================

TEXT ANALYZED:
${text}

ISSUES FOUND (${issues.length}):
${issues.map((issue, i) => `
${i+1}. ${issue.type}
   - Issue: ${issue.message}
   - Context: ${issue.context}
   - Suggestion: ${issue.suggestion}
`).join('')}

STATISTICS:
- Word Count: ${wordCount}
- Character Count: ${charCount}
- Issues Found: ${errorCount}
- Confidence Score: ${confidenceScoreEl.textContent}
- Readability Score: ${scoreValue.textContent || 'N/A'}

Generated by Professional Grammar Checking Tool
                `.trim();
                
                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'grammar-check-report.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function exportAsTxt() {
                const text = textInput.value;
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'corrected-text.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function exportAsHtml() {
                const text = textInput.value;
                const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Corrected Text</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; }
    </style>
</head>
<body>
    <h1>Corrected Text</h1>
    <div>${text.replace(/\n/g, '<br>')}</div>
    <hr>
    <p><em>Generated by Professional Grammar Checking Tool</em></p>
</body>
</html>
                `;
                
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'corrected-text.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });
    </script>
</body>
</html>