<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Grammar Checking Tool</title>
    <style>
        /* CSS Styles */
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #34a853;
            --error-color: #ea4335;
            --warning-color: #fbbc05;
            --info-color: #4285f4;
            --dark-color: #202124;
            --light-color: #f8f9fa;
            --gray-color: #dadce0;
            --success-color: #0f9d58;
            --accent-color: #673ab7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 1.5rem 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .main-title {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .tool-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
        }

        .editor-section, .results-section {
            flex: 1;
            min-width: 300px;
        }

        .text-editor {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            height: 100%;
            position: relative;
        }

        #text-input {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid var(--gray-color);
            border-radius: 4px;
            resize: vertical;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        #text-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.2);
        }

        .highlighted-text {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 15px;
            padding: 15px;
            pointer-events: none;
            z-index: 1;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 16px;
            line-height: 1.6;
            overflow: hidden;
        }

        .error-highlight {
            background-color: rgba(234, 67, 53, 0.2);
            border-bottom: 2px wavy var(--error-color);
        }

        .warning-highlight {
            background-color: rgba(251, 188, 5, 0.2);
            border-bottom: 2px wavy var(--warning-color);
        }

        .info-highlight {
            background-color: rgba(66, 133, 244, 0.2);
            border-bottom: 2px wavy var(--info-color);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1e3d72;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #2d9249;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .stats-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-box {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
            flex: 1;
            min-width: 120px;
            transition: transform 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .results-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            height: 100%;
            max-height: 600px;
            overflow-y: auto;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-color);
        }

        .results-title {
            font-size: 1.3rem;
            color: var(--dark-color);
        }

        .error-list {
            list-style-type: none;
        }

        .error-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: #f9f9f9;
            border-left: 4px solid var(--error-color);
            transition: transform 0.2s;
            cursor: pointer;
        }

        .error-item:hover {
            transform: translateX(5px);
        }

        .error-item.warning {
            border-left-color: var(--warning-color);
        }
        
        .error-item.info {
            border-left-color: var(--info-color);
        }

        .error-item.success {
            border-left-color: var(--success-color);
        }

        .error-type {
            font-weight: bold;
            color: var(--error-color);
            margin-bottom: 5px;
        }

        .error-item.warning .error-type {
            color: var(--warning-color);
        }
        
        .error-item.info .error-type {
            color: var(--info-color);
        }

        .error-item.success .error-type {
            color: var(--success-color);
        }

        .error-context {
            font-style: italic;
            color: #666;
            margin: 5px 0;
        }

        .error-suggestion {
            color: var(--secondary-color);
            font-weight: 500;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        footer {
            text-align: center;
            padding: 20px;
            background-color: var(--dark-color);
            color: white;
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            .tool-container {
                flex-direction: column;
            }
            
            .main-title {
                font-size: 2rem;
            }
        }

        /* Advanced features toggle */
        .advanced-options {
            margin: 20px 0;
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 8px;
        }

        .toggle-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .toggle-icon {
            margin-right: 10px;
            transition: transform 0.3s ease;
        }

        .toggle-icon.rotated {
            transform: rotate(90deg);
        }

        .options-content {
            margin-top: 15px;
            display: none;
        }

        .options-content.show {
            display: block;
        }

        .checkbox-group {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }

        .checkbox-group input {
            margin-right: 8px;
        }

        .readability-score {
            margin-top: 20px;
            padding: 15px;
            background-color: #e6f4ea;
            border-radius: 8px;
        }
        
        .score-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .score-explanation {
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .enhancement-suggestions {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f0fe;
            border-radius: 8px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .dashboard-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .dashboard-label {
            font-size: 0.9rem;
            color: #666;
        }

        .confidence-meter {
            height: 6px;
            background-color: #eee;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .confidence-high {
            background-color: var(--success-color);
        }

        .confidence-medium {
            background-color: var(--warning-color);
        }

        .confidence-low {
            background-color: var(--error-color);
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-color);
        }

        .status-indicator.offline {
            background-color: var(--error-color);
        }

        .tone-analysis {
            margin-top: 20px;
            padding: 15px;
            background-color: #f3e5f5;
            border-radius: 8px;
        }

        .tone-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tone-tag {
            background-color: var(--accent-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .improvement-score {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            background: conic-gradient(var(--secondary-color) 0% var(--p, 0%), #eee var(--p, 0%) 100%);
            position: relative;
        }

        .score-circle::before {
            content: '';
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
        }

        .score-circle span {
            z-index: 1;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .export-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: #f1f3f4;
            color: var(--dark-color);
        }

        .export-btn:hover {
            background-color: #e8eaed;
        }

        .legend {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 2px;
        }

        .legend-error {
            background-color: rgba(234, 67, 53, 0.2);
            border-bottom: 2px wavy var(--error-color);
        }

        .legend-warning {
            background-color: rgba(251, 188, 5, 0.2);
            border-bottom: 2px wavy var(--warning-color);
        }

        .legend-info {
            background-color: rgba(66, 133, 244, 0.2);
            border-bottom: 2px wavy var(--info-color);
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1 class="main-title">Professional Grammar Checking Tool</h1>
            <p class="subtitle">AI-powered grammar, spelling, and style analysis with DeepSeek API</p>
        </div>
    </header>

    <div class="container">
        <div class="dashboard">
            <div class="dashboard-card">
                <div class="dashboard-value" id="word-count">0</div>
                <div class="dashboard-label">Words</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-value" id="char-count">0</div>
                <div class="dashboard-label">Characters</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-value" id="error-count">0</div>
                <div class="dashboard-label">Issues</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-value" id="confidence-score">-</div>
                <div class="dashboard-label">Confidence</div>
                <div class="confidence-meter">
                    <div class="confidence-fill" id="confidence-fill"></div>
                </div>
            </div>
        </div>

        <div class="tool-container">
            <section class="editor-section">
                <div class="text-editor">
                    <h2>Enter Your Text</h2>
                    <div class="highlighted-text" id="highlighted-text"></div>
                    <textarea id="text-input" placeholder="Type or paste your text here to check for grammar, spelling, and style issues..."></textarea>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color legend-error"></div>
                            <span>Errors</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color legend-warning"></div>
                            <span>Warnings</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color legend-info"></div>
                            <span>Suggestions</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="check-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Check Grammar
                        </button>
                        <button class="btn btn-outline" id="clear-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Clear Text
                        </button>
                    </div>

                    <div class="advanced-options">
                        <div class="toggle-header" onclick="toggleAdvancedOptions()">
                            <span class="toggle-icon">▶</span>
                            <h3>Advanced Options</h3>
                        </div>
                        <div class="options-content" id="advanced-options-content">
                            <div class="checkbox-group">
                                <input checked id="check-spelling" type="checkbox">
                                <label for="check-spelling">Check Spelling</label>
                            </div>
                            <div class="checkbox-group">
                                <input checked id="check-grammar" type="checkbox">
                                <label for="check-grammar">Check Grammar</label>
                            </div>
                            <div class="checkbox-group">
                                <input checked id="check-punctuation" type="checkbox">
                                <label for="check-punctuation">Check Punctuation</label>
                            </div>
                            <div class="checkbox-group">
                                <input id="check-style" type="checkbox">
                                <label for="check-style">Check Style (Formal/Informal)</label>
                            </div>
                            <div class="checkbox-group">
                                <input id="check-repetition" type="checkbox">
                                <label for="check-repetition">Check Word Repetition</label>
                            </div>
                            <div class="checkbox-group">
                                <input id="check-readability" type="checkbox" checked>
                                <label for="check-readability">Calculate Readability Score</label>
                            </div>
                            <div class="checkbox-group">
                                <input id="check-vocabulary" type="checkbox">
                                <label for="check-vocabulary">Vocabulary Enhancement</label>
                            </div>
                            <div class="checkbox-group">
                                <input id="check-tone" type="checkbox">
                                <label for="check-tone">Tone Analysis</label>
                            </div>
                        </div>
                    </div>

                    <div class="api-status">
                        <div class="status-indicator" id="api-status"></div>
                        <span id="api-status-text">API Status: Checking...</span>
                    </div>
                </div>
            </section>

            <section class="results-section">
                <div class="results-container">
                    <div class="results-header">
                        <h2 class="results-title">Grammar Check Results</h2>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" id="download-report">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15M7 10L12 15M12 15L17 10M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Download Report
                            </button>
                        </div>
                    </div>

                    <div id="initial-state">
                        <p>Your grammar check results will appear here. Click "Check Grammar" to analyze your text.</p>
                    </div>

                    <div class="hidden" id="loading-state">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Analyzing your text with AI...</p>
                        </div>
                    </div>

                    <div class="hidden" id="results-state">
                        <div class="improvement-score">
                            <div class="score-circle" id="improvement-circle">
                                <span id="improvement-value">0%</span>
                            </div>
                            <div>
                                <h3>Writing Quality</h3>
                                <p>Based on grammar, style, and readability analysis</p>
                            </div>
                        </div>

                        <div class="readability-score hidden" id="readability-score">
                            <h3>Readability Score</h3>
                            <div class="score-value" id="score-value">0</div>
                            <div class="score-explanation" id="score-explanation"></div>
                        </div>
                        
                        <div class="tone-analysis hidden" id="tone-analysis">
                            <h3>Tone Analysis</h3>
                            <div class="tone-tags" id="tone-tags">
                                <!-- Tone tags will be populated here -->
                            </div>
                        </div>
                        
                        <div class="enhancement-suggestions hidden" id="enhancement-suggestions">
                            <h3>Vocabulary Enhancements</h3>
                            <ul id="enhancement-list"></ul>
                        </div>
                        
                        <h3 style="margin: 20px 0 10px 0;">Issues Found</h3>
                        <ul class="error-list" id="error-list">
                            <!-- Errors will be populated here by JavaScript -->
                        </ul>

                        <div class="export-options">
                            <button class="export-btn" id="export-txt">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8M14 2L20 8M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Export as TXT
                            </button>
                            <button class="export-btn" id="export-html">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8M14 2L20 8M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Export as HTML
                            </button>
                            <button class="export-btn" id="export-pdf">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8M14 2L20 8M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Export as PDF
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>© 2023 Professional Grammar Checking Tool. Powered by DeepSeek AI.</p>
        </div>
    </footer>

    <script>
        // Professional Grammar Checker with DeepSeek API
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const textInput = document.getElementById('text-input');
            const highlightedText = document.getElementById('highlighted-text');
            const checkBtn = document.getElementById('check-btn');
            const clearBtn = document.getElementById('clear-btn');
            const wordCountEl = document.getElementById('word-count');
            const charCountEl = document.getElementById('char-count');
            const errorCountEl = document.getElementById('error-count');
            const confidenceScoreEl = document.getElementById('confidence-score');
            const confidenceFillEl = document.getElementById('confidence-fill');
            const errorList = document.getElementById('error-list');
            const initialState = document.getElementById('initial-state');
            const loadingState = document.getElementById('loading-state');
            const resultsState = document.getElementById('results-state');
            const downloadReportBtn = document.getElementById('download-report');
            const readabilityScore = document.getElementById('readability-score');
            const scoreValue = document.getElementById('score-value');
            const scoreExplanation = document.getElementById('score-explanation');
            const enhancementSuggestions = document.getElementById('enhancement-suggestions');
            const enhancementList = document.getElementById('enhancement-list');
            const toneAnalysis = document.getElementById('tone-analysis');
            const toneTags = document.getElementById('tone-tags');
            const improvementCircle = document.getElementById('improvement-circle');
            const improvementValue = document.getElementById('improvement-value');
            const apiStatusEl = document.getElementById('api-status');
            const apiStatusText = document.getElementById('api-status-text');
            const exportTxtBtn = document.getElementById('export-txt');
            const exportHtmlBtn = document.getElementById('export-html');
            const exportPdfBtn = document.getElementById('export-pdf');

            // API Configuration
            const API_KEY = "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";
            const API_URL = "https://openrouter.ai/api/v1/chat/completions";

            // Variables
            let wordCount = 0;
            let charCount = 0;
            let errorCount = 0;
            let currentIssues = [];

            // Initialize
            updateCounters();
            checkAPIStatus();

            // Event Listeners
            textInput.addEventListener('input', function() {
                updateCounters();
                resetResults();
                updateHighlightedText();
            });

            textInput.addEventListener('scroll', function() {
                highlightedText.scrollTop = textInput.scrollTop;
                highlightedText.scrollLeft = textInput.scrollLeft;
            });

            checkBtn.addEventListener('click', checkGrammar);
            clearBtn.addEventListener('click', clearText);
            downloadReportBtn.addEventListener('click', downloadReport);
            exportTxtBtn.addEventListener('click', exportAsTxt);
            exportHtmlBtn.addEventListener('click', exportAsHtml);
            exportPdfBtn.addEventListener('click', exportAsPdf);

            // Functions
            function updateCounters() {
                const text = textInput.value.trim();
                
                // Word count (split by whitespace and filter out empty strings)
                wordCount = text === '' ? 0 : text.split(/\s+/).length;
                wordCountEl.textContent = wordCount;
                
                // Character count (including spaces)
                charCount = text.length;
                charCountEl.textContent = charCount;
            }

            function updateHighlightedText() {
                const text = textInput.value;
                highlightedText.innerHTML = '';
                
                if (currentIssues.length === 0) {
                    highlightedText.textContent = text;
                    return;
                }
                
                // Sort issues by position to process them in order
                const sortedIssues = [...currentIssues].sort((a, b) => a.position - b.position);
                
                let lastIndex = 0;
                let html = '';
                
                sortedIssues.forEach(issue => {
                    // Add text before the issue
                    if (issue.position > lastIndex) {
                        html += escapeHtml(text.substring(lastIndex, issue.position));
                    }
                    
                    // Add the highlighted issue
                    const issueText = escapeHtml(text.substring(issue.position, issue.position + issue.length));
                    const highlightClass = issue.severity === 'error' ? 'error-highlight' : 
                                          issue.severity === 'warning' ? 'warning-highlight' : 'info-highlight';
                    
                    html += `<span class="${highlightClass}" data-issue-id="${issue.id}">${issueText}</span>`;
                    lastIndex = issue.position + issue.length;
                });
                
                // Add remaining text
                if (lastIndex < text.length) {
                    html += escapeHtml(text.substring(lastIndex));
                }
                
                highlightedText.innerHTML = html;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function resetResults() {
                initialState.classList.remove('hidden');
                loadingState.classList.add('hidden');
                resultsState.classList.add('hidden');
                readabilityScore.classList.add('hidden');
                enhancementSuggestions.classList.add('hidden');
                toneAnalysis.classList.add('hidden');
                errorCount = 0;
                errorCountEl.textContent = errorCount;
                downloadReportBtn.disabled = true;
                exportTxtBtn.disabled = true;
                exportHtmlBtn.disabled = true;
                exportPdfBtn.disabled = true;
                currentIssues = [];
                updateHighlightedText();
            }

            function clearText() {
                textInput.value = '';
                updateCounters();
                resetResults();
            }

            function toggleAdvancedOptions() {
                const content = document.getElementById('advanced-options-content');
                const icon = document.querySelector('.toggle-icon');
                content.classList.toggle('show');
                icon.classList.toggle('rotated');
            }

            async function checkAPIStatus() {
                try {
                    const response = await fetch('https://openrouter.ai/api/v1/models', {
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`
                        }
                    });
                    
                    if (response.ok) {
                        apiStatusEl.classList.remove('offline');
                        apiStatusText.textContent = 'API Status: Online';
                    } else {
                        throw new Error('API not available');
                    }
                } catch (error) {
                    apiStatusEl.classList.add('offline');
                    apiStatusText.textContent = 'API Status: Offline - Using fallback analysis';
                }
            }

            async function checkGrammar() {
                const text = textInput.value.trim();
                if (text === '') {
                    alert('Please enter some text to check.');
                    return;
                }

                // Show loading state
                initialState.classList.add('hidden');
                loadingState.classList.remove('hidden');
                resultsState.classList.add('hidden');
                readabilityScore.classList.add('hidden');
                enhancementSuggestions.classList.add('hidden');
                toneAnalysis.classList.add('hidden');

                try {
                    // Try to use DeepSeek API first
                    const aiResults = await checkWithDeepSeekAPI(text);
                    processGrammarCheck(text, aiResults);
                } catch (error) {
                    console.error('API Error:', error);
                    // Fallback to local analysis
                    processGrammarCheck(text);
                }
            }

            async function checkWithDeepSeekAPI(text) {
                const prompt = `
                Analyze the following text for grammar, spelling, punctuation, and style issues. 
                Provide a JSON response with the following structure:
                {
                    "issues": [
                        {
                            "id": "unique-id",
                            "type": "spelling|grammar|punctuation|style",
                            "message": "Description of the issue",
                            "context": "The sentence or phrase where the issue occurs",
                            "suggestion": "How to fix the issue",
                            "position": "starting index of the issue in the text",
                            "length": "length of the problematic text",
                            "severity": "error|warning|info"
                        }
                    ],
                    "readability": {
                        "score": "readability score (0-100)",
                        "level": "reading level description"
                    },
                    "enhancements": [
                        {
                            "original": "word or phrase to enhance",
                            "suggestion": "better alternative",
                            "reason": "reason for the enhancement"
                        }
                    ],
                    "tone": ["list of tone descriptors"],
                    "confidence": "confidence score (0-100)"
                }
                
                Text to analyze: "${text}"
                `;

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Grammar Checker Tool'
                    },
                    body: JSON.stringify({
                        model: "deepseek/deepseek-chat",
                        messages: [
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // Try to parse JSON from the response
                try {
                    return JSON.parse(content);
                } catch (e) {
                    // If JSON parsing fails, extract JSON from the response text
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('Could not parse JSON from API response');
                    }
                }
            }

            function processGrammarCheck(text, aiResults = null) {
                // Hide loading state
                loadingState.classList.add('hidden');
                resultsState.classList.remove('hidden');
                
                // Use AI results if available, otherwise use fallback
                if (aiResults && aiResults.issues) {
                    currentIssues = aiResults.issues;
                } else {
                    // Fallback grammar checking logic
                    currentIssues = performFallbackGrammarCheck(text);
                }
                
                // Update UI with results
                errorCount = currentIssues.length;
                errorCountEl.textContent = errorCount;
                
                // Update confidence score
                const confidenceScore = aiResults?.confidence || Math.max(0, 100 - (errorCount * 2));
                confidenceScoreEl.textContent = `${confidenceScore}%`;
                
                // Update confidence meter
                confidenceFillEl.className = 'confidence-fill';
                if (confidenceScore >= 80) {
                    confidenceFillEl.classList.add('confidence-high');
                } else if (confidenceScore >= 60) {
                    confidenceFillEl.classList.add('confidence-medium');
                } else {
                    confidenceFillEl.classList.add('confidence-low');
                }
                confidenceFillEl.style.width = `${confidenceScore}%`;
                
                // Update improvement score
                const improvementScore = Math.max(10, 100 - (errorCount * 5));
                improvementValue.textContent = `${improvementScore}%`;
                improvementCircle.style.setProperty('--p', `${improvementScore}%`);
                
                // Display issues
                displayIssues(currentIssues);
                
                // Update readability score if available
                if (aiResults?.readability) {
                    readabilityScore.classList.remove('hidden');
                    scoreValue.textContent = aiResults.readability.score;
                    scoreExplanation.textContent = aiResults.readability.level;
                }
                
                // Update enhancement suggestions if available
                if (aiResults?.enhancements && aiResults.enhancements.length > 0) {
                    enhancementSuggestions.classList.remove('hidden');
                    enhancementList.innerHTML = '';
                    aiResults.enhancements.forEach(enhancement => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>"${enhancement.original}"</strong> → <strong>"${enhancement.suggestion}"</strong>: ${enhancement.reason}`;
                        enhancementList.appendChild(li);
                    });
                }
                
                // Update tone analysis if available
                if (aiResults?.tone && aiResults.tone.length > 0) {
                    toneAnalysis.classList.remove('hidden');
                    toneTags.innerHTML = '';
                    aiResults.tone.forEach(tone => {
                        const tag = document.createElement('span');
                        tag.className = 'tone-tag';
                        tag.textContent = tone;
                        toneTags.appendChild(tag);
                    });
                }
                
                // Update highlighted text
                updateHighlightedText();
                
                // Enable download buttons
                downloadReportBtn.disabled = false;
                exportTxtBtn.disabled = false;
                exportHtmlBtn.disabled = false;
                exportPdfBtn.disabled = false;
            }

            function performFallbackGrammarCheck(text) {
                const issues = [];
                const words = text.split(/\s+/);
                
                // Simple spelling check for common mistakes
                const commonMistakes = [
                    { wrong: 'teh', correct: 'the' },
                    { wrong: 'adn', correct: 'and' },
                    { wrong: 'recieve', correct: 'receive' },
                    { wrong: 'seperate', correct: 'separate' },
                    { wrong: 'definately', correct: 'definitely' },
                    { wrong: 'occured', correct: 'occurred' },
                    { wrong: 'alot', correct: 'a lot' }
                ];
                
                commonMistakes.forEach(mistake => {
                    const regex = new RegExp(`\\b${mistake.wrong}\\b`, 'gi');
                    let match;
                    while ((match = regex.exec(text)) !== null) {
                        issues.push({
                            id: `spelling-${match.index}`,
                            type: 'spelling',
                            message: `Possible spelling mistake: "${mistake.wrong}"`,
                            context: getContext(text, match.index, mistake.wrong.length),
                            suggestion: `Did you mean "${mistake.correct}"?`,
                            position: match.index,
                            length: mistake.wrong.length,
                            severity: 'error'
                        });
                    }
                });
                
                // Check for repeated words
                const repeatedWordRegex = /\b(\w+)\s+\1\b/gi;
                let match;
                while ((match = repeatedWordRegex.exec(text)) !== null) {
                    issues.push({
                        id: `repetition-${match.index}`,
                        type: 'repetition',
                        message: 'Repeated word',
                        context: getContext(text, match.index, match[0].length),
                        suggestion: `Remove the duplicate "${match[1]}"`,
                        position: match.index,
                        length: match[0].length,
                        severity: 'warning'
                    });
                }
                
                // Check for common grammar issues
                if (text.length > 0 && !text.endsWith('.') && !text.endsWith('!') && !text.endsWith('?')) {
                    issues.push({
                        id: 'punctuation-end',
                        type: 'punctuation',
                        message: 'Missing ending punctuation',
                        context: 'The text does not end with proper punctuation',
                        suggestion: 'Add a period, question mark, or exclamation point at the end',
                        position: text.length - 1,
                        length: 1,
                        severity: 'warning'
                    });
                }
                
                // Check for capitalization at the beginning
                if (text.length > 0 && !text[0].match(/[A-Z]/)) {
                    issues.push({
                        id: 'capitalization-start',
                        type: 'capitalization',
                        message: 'Sentence should start with a capital letter',
                        context: getContext(text, 0, 1),
                        suggestion: 'Capitalize the first letter',
                        position: 0,
                        length: 1,
                        severity: 'error'
                    });
                }
                
                return issues;
            }

            function getContext(text, position, length) {
                const start = Math.max(0, position - 20);
                const end = Math.min(text.length, position + length + 20);
                return text.substring(start, end);
            }

            function displayIssues(issues) {
                errorList.innerHTML = '';
                
                if (issues.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'error-item success';
                    li.innerHTML = `
                        <div class="error-type">No Issues Found</div>
                        <div class="error-suggestion">Your text looks great! No grammar, spelling, or style issues detected.</div>
                    `;
                    errorList.appendChild(li);
                    return;
                }
                
                issues.forEach(issue => {
                    const li = document.createElement('li');
                    li.className = `error-item ${issue.severity}`;
                    li.innerHTML = `
                        <div class="error-type">${issue.type.charAt(0).toUpperCase() + issue.type.slice(1)} ${issue.severity}</div>
                        <div class="error-context">"${issue.context}"</div>
                        <div class="error-suggestion">${issue.suggestion}</div>
                    `;
                    li.addEventListener('click', () => {
                        // Scroll to the issue in the text input
                        textInput.focus();
                        textInput.setSelectionRange(issue.position, issue.position + issue.length);
                        textInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                    errorList.appendChild(li);
                });
            }

            function downloadReport() {
                const text = textInput.value;
                const report = generateReport(text);
                
                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'grammar-check-report.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function generateReport(text) {
                let report = `GRAMMAR CHECK REPORT\n`;
                report += `Generated: ${new Date().toLocaleString()}\n`;
                report += `Text Length: ${text.length} characters, ${wordCount} words\n`;
                report += `Issues Found: ${errorCount}\n\n`;
                report += `TEXT:\n${text}\n\n`;
                report += `ISSUES:\n`;
                
                if (currentIssues.length === 0) {
                    report += `No issues found. Your text looks great!\n`;
                } else {
                    currentIssues.forEach((issue, index) => {
                        report += `${index + 1}. [${issue.type.toUpperCase()}] ${issue.message}\n`;
                        report += `   Context: "${issue.context}"\n`;
                        report += `   Suggestion: ${issue.suggestion}\n\n`;
                    });
                }
                
                return report;
            }

            function exportAsTxt() {
                const text = textInput.value;
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'corrected-text.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function exportAsHtml() {
                const text = textInput.value;
                const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Corrected Text</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 20px; }
                        .error-highlight { background-color: rgba(234, 67, 53, 0.2); border-bottom: 2px wavy #ea4335; }
                        .warning-highlight { background-color: rgba(251, 188, 5, 0.2); border-bottom: 2px wavy #fbbc05; }
                        .info-highlight { background-color: rgba(66, 133, 244, 0.2); border-bottom: 2px wavy #4285f4; }
                    </style>
                </head>
                <body>
                    <div>${formatTextWithHighlights(text)}</div>
                </body>
                </html>
                `;
                
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'corrected-text.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function formatTextWithHighlights(text) {
                if (currentIssues.length === 0) {
                    return text.replace(/\n/g, '<br>');
                }
                
                // Sort issues by position to process them in order
                const sortedIssues = [...currentIssues].sort((a, b) => a.position - b.position);
                
                let lastIndex = 0;
                let html = '';
                
                sortedIssues.forEach(issue => {
                    // Add text before the issue
                    if (issue.position > lastIndex) {
                        html += escapeHtml(text.substring(lastIndex, issue.position)).replace(/\n/g, '<br>');
                    }
                    
                    // Add the highlighted issue
                    const issueText = escapeHtml(text.substring(issue.position, issue.position + issue.length));
                    const highlightClass = issue.severity === 'error' ? 'error-highlight' : 
                                          issue.severity === 'warning' ? 'warning-highlight' : 'info-highlight';
                    
                    html += `<span class="${highlightClass}">${issueText}</span>`;
                    lastIndex = issue.position + issue.length;
                });
                
                // Add remaining text
                if (lastIndex < text.length) {
                    html += escapeHtml(text.substring(lastIndex)).replace(/\n/g, '<br>');
                }
                
                return html;
            }

            function exportAsPdf() {
                alert('PDF export would be implemented with a PDF generation library like jsPDF. This is a placeholder for the functionality.');
                // In a real implementation, you would use a library like jsPDF to generate a PDF
                // For this demo, we'll just create a text file with a PDF extension
                const text = textInput.value;
                const blob = new Blob([text], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'corrected-text.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });
    </script>
</body>
</html>