// Working PDF Export functionality with jsPDF + autoTable
class PDFExporter {
    constructor() {
        this.isJSPDFLoaded = typeof jspdf !== 'undefined';
        this.init();
    }

    init() {
        if (!this.isJSPDFLoaded) {
            console.warn('jsPDF not loaded, PDF exports will not work');
        }
    }

    exportRoster(rosterData, format = 'simple') {
        if (!this.isJSPDFLoaded) {
            rosterGenerator.showNotification('PDF library not loaded. Please refresh the page.', 'error');
            return;
        }

        try {
            const { jsPDF } = window.jspdf;
            
            switch (format) {
                case 'detailed':
                    this.generateDetailedPDF(jsPDF, rosterData);
                    break;
                case 'booklet':
                    this.generateBookletPDF(jsPDF, rosterData);
                    break;
                default:
                    this.generateSimplePDF(jsPDF, rosterData);
            }
            
        } catch (error) {
            console.error('PDF generation error:', error);
            rosterGenerator.showNotification('PDF generation failed: ' + error.message, 'error');
        }
    }

    generateSimplePDF(jsPDF, rosterData) {
        const doc = new jsPDF();
        
        // Header
        doc.setFontSize(20);
        doc.setTextColor(46, 125, 50);
        doc.text('MORNING ASSEMBLY ROSTER', 105, 20, { align: 'center' });
        
        doc.setFontSize(14);
        doc.setTextColor(100, 100, 100);
        doc.text(rosterData.schoolName, 105, 30, { align: 'center' });
        
        doc.setFontSize(12);
        doc.setTextColor(76, 175, 80);
        doc.text(`"${rosterData.theme}"`, 105, 38, { align: 'center' });
        
        // Assembly Details
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text(`Date: ${this.formatDate(rosterData.date)}`, 20, 50);
        doc.text(`Grade: ${rosterData.grade}`, 20, 57);
        doc.text(`Total Time: ${rosterData.totalTime} minutes`, 20, 64);
        doc.text(`Language: ${rosterData.language}`, 20, 71);
        
        // Prepare table data
        const tableData = rosterData.activities.map(activity => [
            activity.order.toString(),
            activity.name,
            activity.leadBy,
            activity.time
        ]);
        
        // Add table
        doc.autoTable({
            startY: 80,
            head: [['Order', 'Activity', 'Lead By', 'Time']],
            body: tableData,
            styles: { 
                fontSize: 9,
                cellPadding: 3
            },
            headStyles: { 
                fillColor: [76, 175, 80],
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [245, 245, 245]
            },
            margin: { top: 80 }
        });
        
        // Total time
        const finalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(`Total Assembly Time: ${this.calculateTotalTime(rosterData.activities)} minutes`, 20, finalY);
        
        // Footer
        doc.setFont(undefined, 'normal');
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text('Generated by Morning Assembly Roster Generator - Advanced Edition', 105, 280, { align: 'center' });
        doc.text(`Created on ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });
        
        // Save PDF
        doc.save(`Assembly_Roster_${rosterData.grade}_${rosterData.date.replace(/-/g, '_')}.pdf`);
        rosterGenerator.showNotification('Simple PDF downloaded successfully!', 'success');
    }

    generateDetailedPDF(jsPDF, rosterData) {
        const doc = new jsPDF();
        
        // Header with background
        doc.setFillColor(76, 175, 80);
        doc.rect(0, 0, 210, 30, 'F');
        
        doc.setFontSize(18);
        doc.setTextColor(255, 255, 255);
        doc.text('MORNING ASSEMBLY ROSTER', 105, 12, { align: 'center' });
        
        doc.setFontSize(12);
        doc.text(rosterData.schoolName, 105, 20, { align: 'center' });
        
        // Theme
        doc.setFontSize(14);
        doc.setTextColor(76, 175, 80);
        doc.text(`"${rosterData.theme}"`, 105, 35, { align: 'center' });
        
        // Details box
        doc.setFillColor(240, 240, 240);
        doc.roundedRect(15, 45, 180, 25, 3, 3, 'F');
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text(`Date: ${this.formatDate(rosterData.date)}`, 20, 55);
        doc.text(`Grade: ${rosterData.grade}`, 20, 62);
        doc.text(`Total Time: ${rosterData.totalTime} minutes`, 110, 55);
        doc.text(`Language: ${rosterData.language}`, 110, 62);
        
        let yPosition = 85;
        
        // Activities with descriptions
        rosterData.activities.forEach(activity => {
            if (yPosition > 250) {
                doc.addPage();
                yPosition = 20;
            }
            
            // Activity header
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(46, 125, 50);
            doc.text(`${activity.order}. ${activity.name}`, 20, yPosition);
            
            // Time badge
            const timeWidth = doc.getTextWidth(activity.time) + 6;
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(180 - timeWidth, yPosition - 4, timeWidth, 6, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text(activity.time, 180 - timeWidth/2, yPosition, { align: 'center' });
            
            yPosition += 7;
            
            // Lead by
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(`Lead by: ${activity.leadBy}`, 20, yPosition);
            
            yPosition += 5;
            
            // Description
            const descriptionLines = doc.splitTextToSize(activity.description, 170);
            doc.setTextColor(80, 80, 80);
            doc.text(descriptionLines, 20, yPosition);
            
            yPosition += (descriptionLines.length * 4) + 10;
            
            // Separator
            if (yPosition < 270) {
                doc.setDrawColor(200, 200, 200);
                doc.line(20, yPosition - 5, 190, yPosition - 5);
            }
        });
        
        // Footer
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text('Generated by Morning Assembly Roster Generator - Advanced Edition', 105, 280, { align: 'center' });
        doc.text(`Created on ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });
        
        doc.save(`Assembly_Roster_Detailed_${rosterData.grade}_${rosterData.date.replace(/-/g, '_')}.pdf`);
        rosterGenerator.showNotification('Detailed PDF downloaded successfully!', 'success');
    }

    generateBookletPDF(jsPDF, rosterData) {
        const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a4'
        });
        
        // Title
        doc.setFontSize(16);
        doc.setTextColor(46, 125, 50);
        doc.text('ASSEMBLY SCHEDULE - QUICK REFERENCE', 148, 15, { align: 'center' });
        
        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        doc.text(`Grade ${rosterData.grade} â€¢ ${this.formatDate(rosterData.date)}`, 148, 22, { align: 'center' });
        
        doc.setFontSize(11);
        doc.setTextColor(76, 175, 80);
        doc.text(`"${rosterData.theme}"`, 148, 28, { align: 'center' });
        
        // Two-column layout
        const columnWidth = 120;
        const column1X = 20;
        const column2X = 160;
        let col1Y = 40;
        let col2Y = 40;
        
        rosterData.activities.forEach((activity, index) => {
            const isFirstColumn = index < Math.ceil(rosterData.activities.length / 2);
            const x = isFirstColumn ? column1X : column2X;
            let y = isFirstColumn ? col1Y : col2Y;
            
            // Activity card
            doc.setDrawColor(200, 200, 200);
            doc.setFillColor(250, 250, 250);
            doc.roundedRect(x, y, columnWidth - 10, 20, 2, 2, 'FD');
            
            // Order and time
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(46, 125, 50);
            doc.text(activity.order.toString(), x + 5, y + 7);
            
            // Time badge
            doc.setFillColor(76, 175, 80);
            doc.roundedRect(x + columnWidth - 25, y + 3, 20, 6, 1, 1, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text(activity.time, x + columnWidth - 15, y + 7, { align: 'center' });
            
            // Activity name
            doc.setTextColor(0, 0, 0);
            const activityName = doc.splitTextToSize(activity.name, columnWidth - 40);
            doc.text(activityName, x + 15, y + 7);
            
            // Lead by
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(`Lead: ${activity.leadBy}`, x + 15, y + 15);
            
            if (isFirstColumn) {
                col1Y += 25;
            } else {
                col2Y += 25;
            }
        });
        
        // Footer
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text('Quick Reference - Morning Assembly Roster Generator', 148, 190, { align: 'center' });
        
        doc.save(`Assembly_Roster_Booklet_${rosterData.grade}_${rosterData.date.replace(/-/g, '_')}.pdf`);
        rosterGenerator.showNotification('Booklet PDF downloaded successfully!', 'success');
    }

    showExportOptions(rosterData) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; align-items: center;
            justify-content: center; z-index: 10000;
        `;
        
        modal.innerHTML = `
            <div style="background: white; padding: 2rem; border-radius: 10px; max-width: 500px; width: 90%;">
                <h3 style="color: #2E7D32; margin-bottom: 15px;">Export to PDF - Choose Format</h3>
                <p style="color: #666; margin-bottom: 20px;">Select the PDF format that best suits your needs:</p>
                <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
                    <button class="pdf-format-btn" data-format="simple" 
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; cursor: pointer; text-align: left; transition: all 0.3s;">
                        <strong style="color: #2E7D32;">Simple PDF</strong>
                        <br><small style="color: #666;">Clean, one-page layout with table</small>
                    </button>
                    <button class="pdf-format-btn" data-format="detailed" 
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; cursor: pointer; text-align: left; transition: all 0.3s;">
                        <strong style="color: #2E7D32;">Detailed PDF</strong>
                        <br><small style="color: #666;">With activity descriptions and formatting</small>
                    </button>
                    <button class="pdf-format-btn" data-format="booklet" 
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; cursor: pointer; text-align: left; transition: all 0.3s;">
                        <strong style="color: #2E7D32;">Booklet Format</strong>
                        <br><small style="color: #666;">Compact two-column quick reference</small>
                    </button>
                </div>
                <button id="closePdfModal" style="margin-top: 10px; padding: 10px; border: 2px solid #ccc; border-radius: 8px; background: white; cursor: pointer; width: 100%;">
                    Cancel
                </button>
            </div>
        `;

        document.body.appendChild(modal);

        // Add hover effects
        modal.querySelectorAll('.pdf-format-btn').forEach(btn => {
            btn.addEventListener('mouseenter', () => {
                btn.style.borderColor = '#4CAF50';
                btn.style.background = '#f1f8e9';
            });
            btn.addEventListener('mouseleave', () => {
                btn.style.borderColor = '#e0e0e0';
                btn.style.background = 'white';
            });
        });

        // Add event listeners
        modal.querySelectorAll('.pdf-format-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                this.exportRoster(rosterData, btn.dataset.format);
                document.body.removeChild(modal);
            });
        });

        modal.querySelector('#closePdfModal').addEventListener('click', () => {
            document.body.removeChild(modal);
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }

    calculateTotalTime(activities) {
        return activities.reduce((total, activity) => {
            const timeMatch = activity.time.match(/(\d+)/);
            return total + (timeMatch ? parseInt(timeMatch[1]) : 0);
        }, 0);
    }

    formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'long'
        });
    }
}

// Initialize PDF Exporter
const pdfExporter = new PDFExporter();