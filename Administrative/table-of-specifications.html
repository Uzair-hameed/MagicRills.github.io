<div class="separator" style="clear: both;"><a href="https://cdn-icons-png.flaticon.com/128/7603/7603938.png" style="display: block; padding: 1em 0px; text-align: center;"><img alt="" border="0" data-original-height="128" data-original-width="128" src="https://cdn-icons-png.flaticon.com/128/7603/7603938.png" style="display: none;" /></a></div>





<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Enhanced Table of Specifications (Auto) — Sindh</title>
<style>
/* ========== Minimal, compact CSS ========== */
body{margin:0;background:#f5f7fb}
#tosApp{font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;max-width:1140px;margin:18px auto;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.03)}
.tos-row{display:flex;gap:12px;flex-wrap:wrap}
.tos-col{flex:1 1 360px;min-width:340px}
h2{font-size:20px;margin:6px 0 10px}
h3{font-size:15px;margin:10px 0 6px;color:#333}
label{font-size:12px;color:#444;margin:6px 0 2px;display:block}
input,select,textarea,button{font:inherit}
input,select,textarea{width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:8px;background:#fff}
textarea{min-height:130px}
small{color:#666}
.btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
button{background:#1769aa;color:#fff;border:none;border-radius:8px;padding:8px 10px;cursor:pointer}
button.sec{background:#374151}
button.ghost{background:#fff;border:1px solid #bbb;color:#333}
button.warn{background:#b45309}
.grid{width:100%;overflow:auto;border:1px solid #eee;border-radius:8px}
table{border-collapse:collapse;width:100%;font-size:12px}
th,td{border:1px solid #eee;padding:6px 8px;text-align:center}
th{background:#f6f8fa}
.badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:11px;background:#eef}
.note{background:#f8fafc;border:1px dashed #cbd5e1;border-radius:8px;padding:8px}
.flex{display:flex;gap:8px;align-items:center}
.num{width:110px}
.kv{display:grid;grid-template-columns:1fr 1fr;gap:6px}
hr{border:none;border-top:1px dashed #ddd;margin:10px 0}
.warnTxt{color:#b45309}
.okTxt{color:#15803d}
summary{cursor:pointer;font-weight:600}
.print-only{display:none}
@media print{
  #tosApp{border:none;box-shadow:none}
  .no-print{display:none!important}
  .print-only{display:block}
  body{-webkit-print-color-adjust:exact;print-color-adjust:exact}
}
.rtl{direction:rtl}
.rtl .tos-row,.rtl .btns,.rtl .flex{flex-direction:row-reverse}
.code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#f6f8fa;border:1px solid #e5e7eb;border-radius:6px;padding:6px;font-size:12px}
.rubric-item{margin-bottom:10px;padding:8px;border:1px solid #e5e7eb;border-radius:6px;background:#f8fafc}
.rubric-levels{display:flex;gap:8px;margin-top:6px}
.rubric-level{flex:1;padding:6px;border-radius:4px;background:#fff;border:1px solid #e5e7eb}
.rubric-level h4{margin:0 0 4px 0;font-size:12px}
.rubric-level p{margin:0;font-size:11px;color:#555}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#fff;padding:20px;border-radius:8px;max-width:600px;width:90%;max-height:80vh;overflow:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.modal-header h3{margin:0}
.modal-close{background:none;border:none;font-size:20px;cursor:pointer}
</style>
</head>
<body>
<div id="tosApp">
  <div class="tos-row no-print">
    <div class="tos-col">
      <h2>Enhanced Table of Specifications (Auto) — Sindh</h2>
      <div class="kv">
        <div>
          <label>Grade / ž»ž▒ž¼█ü</label>
          <select id="gradeSel"></select>
        </div>
        <div class="flex">
          <div>
            <label>Language</label>
            <select id="langSel" class="num">
              <option value="en">English</option>
              <option value="ur">ž¦ž▒ž»┘ł</option>
            </select>
          </div>
          <label class="badge">RTL</label>
          <input id="rtlChk" type="checkbox" />
        </div>
      </div>
      <div id="groupWrap" style="display:none">
        <label>Grade 9–10 Group (Sindh)</label>
        <select id="groupSel"></select>
      </div>
      <label>Subject / ┘ģžČ┘ģ┘ł┘å</label>
      <select id="subjectSel"></select>
      <div class="kv">
        <div>
          <label>Exam/Term</label>
          <input id="examInp" placeholder="Midterm / Final / Board Practice">
        </div>
        <div>
          <label>Policy Profile</label>
          <select id="policySel">
            <option value="sindh">Sindh – SELD defaults</option>
            <option value="custom">Custom (from Policy Manager)</option>
          </select>
        </div>
      </div>
      <div class="kv">
        <div><label>Total Marks</label><input id="marksInp" type="number" min="10" max="200" value="50"></div>
        <div><label>Duration (minutes)</label><input id="timeInp" type="number" min="10" max="240" value="60"></div>
      </div>

      <h3>Bloom targets (%)</h3>
      <div class="grid">
        <table>
          <thead><tr id="bloomHead"></tr></thead>
          <tbody><tr id="bloomRow"></tr></tbody>
        </table>
      </div>
      <small>Auto-fills by grade; you can tweak.</small>

      <h3>Difficulty targets (%)</h3>
      <div class="grid">
        <table>
          <thead><tr id="diffHead"></tr></thead>
          <tbody><tr id="diffRow"></tr></tbody>
        </table>
      </div>
      <small>Default: Easy 40 · Moderate 45 · Hard 15</small>
    </div>

    <div class="tos-col">
      <h3>Content entry (Chapters → Topics → Subtopics)</h3>
      <textarea id="contentTa" placeholder="Examples:
Chapter: Cell Biology
- Topic: Cell Organelles
> Identify nucleus, mitochondria
> Explain functions of ribosomes
- Topic: Cell Membrane
> Describe diffusion and osmosis

Chapter: Photosynthesis
- Topic: Light Reactions
> Differentiate photosystems I and II
> Justify the role of chlorophyll"></textarea>
      <div class="btns">
        <button id="exBtn" class="ghost">Load Small Example</button>
        <button id="parseBtn">Auto Classify + Allocate</button>
        <button id="generateQuestionsBtn" class="ghost">Generate Questions</button>
      </div>
      <div class="note"><b>Tips</b>
        <ul style="margin:4px 0 0 16px;padding:0">
          <li>Use "Chapter:" for new chapter, "- Topic:" for topics, and "> ..." for subtopics/SLOs.</li>
          <li>Verbs in English/Urdu/Sindhi help auto-detect Bloom levels.</li>
          <li>Click "Generate Questions" to create questions from your content.</li>
        </ul>
      </div>
    </div>
  </div>

  <details class="no-print" style="margin:8px 0">
    <summary>Policy Manager (Sindh) — paste/update Scheme of Studies and Groups</summary>
    <div class="note" style="margin:8px 0">
      - From your PDF (Google Drive → Open with Google Docs), copy subject/group tables. Replace the JSON below, then click Apply → Save to Browser.
      <br> - This updates grade-wise subjects and 9–10 groups in the dropdowns.
    </div>
    <div class="btns">
      <button id="loadDefaultsBtn" class="ghost">Load Defaults</button>
      <button id="applyPolicyBtn">Apply to App</button>
      <button id="savePolicyBtn" class="sec">Save to Browser</button>
      <button id="exportPolicyBtn" class="ghost">Export JSON</button>
      <label class="ghost" style="padding:7px 10px">
        Import JSON <input id="importPolicyFile" type="file" accept=".json" style="display:none">
      </label>
    </div>
    <textarea id="policyJsonTa" class="code" style="min-height:200px"></textarea>
  </details>

  <div class="tos-row">
    <div class="tos-col">
      <h3>Table of Specifications (Chapters × Bloom)</h3>
      <div id="tosWrap" class="grid"></div>
      <div id="tosInfo" style="margin-top:8px"></div>
      <div class="btns no-print">
        <button id="printBtn" class="sec">Print / PDF</button>
        <button id="csvTosBtn" class="ghost">Export ToS (CSV)</button>
        <button id="xlsTosBtn" class="ghost">Export ToS (Excel)</button>
        <button id="generateRubricsBtn" class="ghost">Generate Rubrics</button>
      </div>
    </div>
    <div class="tos-col">
      <h3>Item Blueprint</h3>
      <div id="blueWrap" class="grid"></div>
      <div class="btns no-print">
        <button id="csvItemsBtn" class="ghost">Export Items (CSV)</button>
      </div>
    </div>
  </div>

  <div class="note no-print" style="margin-top:10px">
    <b>Coverage checks</b>
    <div id="checks"></div>
  </div>
</div>

<!-- Rubrics Modal -->
<div id="rubricsModal" class="modal" style="display:none">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Generated Rubrics</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div id="rubricsContent"></div>
    <div class="btns" style="margin-top:15px">
      <button id="exportRubricsBtn" class="sec">Export Rubrics</button>
      <button id="closeRubricsBtn" class="ghost">Close</button>
    </div>
  </div>
</div>

<!-- Questions Modal -->
<div id="questionsModal" class="modal" style="display:none">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Generated Questions</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div id="questionsContent"></div>
    <div class="btns" style="margin-top:15px">
      <button id="exportQuestionsBtn" class="sec">Export Questions</button>
      <button id="closeQuestionsBtn" class="ghost">Close</button>
    </div>
  </div>
</div>

<script>
/* ========== Enhanced ToS Builder (Auto Mode) ========== */
/* — Added Rubrics and Question Generation features — */

/* Shortcuts */
const $=(s,el=document)=>el.querySelector(s);
const $$=(s,el=document)=>[...el.querySelectorAll(s)];
const CE=(t,p={})=>Object.assign(document.createElement(t),p);

/* Bloom / KD / Difficulty */
const BLOOM=["Remember","Understand","Apply","Analyze","Evaluate","Create"];
const KD=["Factual","Conceptual","Procedural","Metacognitive"];
const DIFF=["Easy","Moderate","Hard"];

/* Default targets */
const STAGE_TARGETS={
  g1_3:{Remember:45,Understand:35,Apply:15,Analyze:5,Evaluate:0,Create:0},
  g4_6:{Remember:35,Understand:35,Apply:20,Analyze:8,Evaluate:2,Create:0},
  g7_8:{Remember:25,Understand:30,Apply:25,Analyze:12,Evaluate:5,Create:3},
  g9_10:{Remember:18,Understand:28,Apply:28,Analyze:12,Evaluate:8,Create:6}
};
const DIFF_DEFAULT={Easy:40,Moderate:45,Hard:15}; // %
const ITEM_TYPES={MCQ:{marks:1,time:1},Short:{marks:2,time:3},Structured:{marks:5,time:8},Extended:{marks:10,time:15}};
const MIX_BY_BLOOM={
  Remember:{MCQ:.9,Short:.1,Structured:0,Extended:0},
  Understand:{MCQ:.7,Short:.3,Structured:0,Extended:0},
  Apply:{MCQ:.35,Short:.5,Structured:.15,Extended:0},
  Analyze:{MCQ:.2,Short:.45,Structured:.35,Extended:0},
  Evaluate:{MCQ:.15,Short:.35,Structured:.35,Extended:.15},
  Create:{MCQ:0,Short:.2,Structured:.5,Extended:.3}
};

/* Multilingual verbs */
const RE_VERBS={
  Remember:[/define|list|state|recall|identify|label|name|match|memorize|enumerate/i,/(ž¬ž╣ž▒█ī┘ü|┘ü█üž▒ž│ž¬|ž©█īž¦┘å|█īž¦ž»|┘Š█ü┌åž¦┘å|┘ä█īž©┘ä|┘åž¦┘ģ|┌»┘å┘åž¦)/,/(ž¬ž╣ž▒┘Ŗ┘ü|┘ü┘ćž▒ž│ž¬|ž©┘Ŗž¦┘å|┘Ŗž¦ž»|ž│┌āž¦┌╗|┘åž¦┘ä┘ł)/],
  Understand:[/explain|describe|summarize|classify|illustrate|interpret|paraphrase/i,/(┘łžČž¦žŁž¬|ž©█īž¦┘å|ž«┘äž¦žĄ█ü|ž»ž▒ž¼█ü ž©┘åž»█ī|ž¬ž┤ž▒█īžŁ)/,/(┘łžČž¦žŁž¬|ž¬ž┤ž▒┘ŖžŁ|ž«┘äž¦žĄ┘ł|ž»ž▒ž¼ž¦ž©┘åž»┘Ŗ)/],
  Apply:[/apply|solve|use|compute|calculate|demonstrate|implement|perform/i,/(ž¦ž│ž¬ž╣┘ģž¦┘ä|žŁ┘ä|žŁž│ž¦ž©|ž»┌®┌Šž¦ž”█ī┌║|┘åž¦┘üž░|ž¦ž»ž¦┌®ž▒┘åž¦)/,/(ž¦ž│ž¬ž╣┘ģž¦┘ä|žŁ┘ä|žŁž│ž¦ž©|┘äž¦┌│┘ł|ž¦ž»ž¦)/],
  Analyze:[/analy[sz]e|compare|contrast|differentiate|infer|organize|structure|break down/i,/(ž¬ž¼ž▓█ī█ü|┘ģ┘łž¦ž▓┘å█ü|┘üž▒┘é|ž¦ž«ž░|┘ģ┘åžĖ┘ģ|ž│ž¦ž«ž¬)/,/(ž¬ž¼ž▓┘Ŗ┘ł|┘ģ┘łž¦ž▓┘å█ü|┘üž▒┘é|┘åž¬┘Ŗž¼┘ł ┌¬┌Ź┘ł|┘ģ┘åžĖ┘ģ)/],
  Evaluate:[/evaluate|judge|justify|critique|assess|defend|argue|appraise/i,/(ž¼ž¦┘å┌å|ž¼┘łž¦ž▓|ž¬┘å┘é█īž»|┘Šž▒┌®┌Š|ž»┘üž¦ž╣|ž»┘äž¦žž»)/,/(ž¼ž¦┌å|ž¼┘łž¦ž▓|ž¬┘å┘é┘Ŗž»|┘Šž▒┌®|ž»┘üž¦ž╣|ž»┘ä┘Ŗ┘ä)/],
  Create:[/create|design|compose|develop|formulate|construct|plan|produce|invent/i,/(ž¬█īž¦ž▒|┌ł█īž▓ž¦ž»┘å|ž¬ž┤┌®█ī┘ä|┘łžČž╣|┘ģ┘åžĄ┘łž©█ü|ž¦█īž¼ž¦ž»)/,/(ž¬┘Ŗž¦ž▒|┌Ŗ┘Ŗž▓ž¦ž»┘å|ž¬ž┤┌¬┘Ŗ┘ä|┘łžČž╣|┘ģ┘åžĄ┘łž©┘ł|ž¦┘Ŗž¼ž¦ž»)/]
};
const KD_HINTS={
  Factual:[/define|list|identify|term|fact|properties|label|symbol/i,/(ž¬ž╣ž▒█ī┘ü|┘ü█üž▒ž│ž¬|┘Š█ü┌åž¦┘å|žŁ┘éž¦ž”┘é|ž¦žĄžĘ┘äž¦žŁ)/],
  Conceptual:[/concept|explain|classify|compare|principle|model|theory|relationship/i,/(┘ģ┘ü█ü┘ł┘ģ|┘łžČž¦žŁž¬|ž»ž▒ž¼█ü|┘ģ┘łž¦ž▓┘å█ü|ž¦žĄ┘ł┘ä|ž¬žĄ┘łž▒)/],
  Procedural:[/procedure|method|steps|solve|calculate|algorithm|technique|demonstrate/i,/(žĘž▒█ī┘é█ü|┘ģž▒ž¦žŁ┘ä|žŁ┘ä|žŁž│ž¦ž©|žĘž▒█ī┘é█ü ┌®ž¦ž▒)/],
  Metacognitive:[/strategy|reflect|monitor|plan your|evaluate your|self/i,/(žŁ┌®┘ģž¬ ž╣┘ģ┘ä█ī|ž¼ž¦ž”ž▓█ü|ž«┘łž»|ž«┘łž» ž¼ž¦┘å┌å|┘ģ┘åžĄ┘łž©█ü)/]
};

/* Question templates by Bloom level */
const QUESTION_TEMPLATES = {
  Remember: [
    "Define {topic}.",
    "List the main components of {topic}.",
    "Identify the {topic} from the given description.",
    "What are the key characteristics of {topic}?",
    "Recall the definition of {topic}."
  ],
  Understand: [
    "Explain {topic} in your own words.",
    "Describe how {topic} works.",
    "Summarize the key points about {topic}.",
    "What is the main idea behind {topic}?",
    "Give an example of {topic}."
  ],
  Apply: [
    "How would you use {topic} to solve this problem?",
    "Demonstrate how {topic} can be applied in this situation.",
    "Calculate {topic} for the given scenario.",
    "Solve this problem using {topic}.",
    "Implement {topic} to address this challenge."
  ],
  Analyze: [
    "Compare and contrast {topic} with {relatedTopic}.",
    "What are the differences between {topic} and {relatedTopic}?",
    "Break down {topic} into its main components.",
    "Analyze the relationship between {topic} and {relatedTopic}.",
    "What patterns can you identify in {topic}?"
  ],
  Evaluate: [
    "Evaluate the effectiveness of {topic}.",
    "Justify why {topic} is important.",
    "Assess the strengths and weaknesses of {topic}.",
    "Defend your position on {topic}.",
    "Critique the implementation of {topic}."
  ],
  Create: [
    "Design a new approach to {topic}.",
    "Develop a plan to improve {topic}.",
    "Invent a solution for {topic}.",
    "Compose a new theory about {topic}.",
    "Propose an innovative application of {topic}."
  ]
};

/* Rubric templates by Bloom level */
const RUBRIC_TEMPLATES = {
  Remember: {
    criteria: ["Accuracy", "Completeness", "Clarity"],
    levels: [
      {name: "Excellent", desc: "All facts are accurate and complete with clear presentation"},
      {name: "Good", desc: "Most facts are accurate with minor omissions or unclear points"},
      {name: "Fair", desc: "Some inaccuracies or significant omissions present"},
      {name: "Poor", desc: "Many inaccuracies or incomplete information"}
    ]
  },
  Understand: {
    criteria: ["Explanation", "Examples", "Organization"],
    levels: [
      {name: "Excellent", desc: "Clear, thorough explanation with relevant examples and logical organization"},
      {name: "Good", desc: "Good explanation with some examples and mostly logical organization"},
      {name: "Fair", desc: "Basic explanation with few examples and some organizational issues"},
      {name: "Poor", desc: "Unclear explanation lacking examples and organization"}
    ]
  },
  Apply: {
    criteria: ["Application", "Procedure", "Accuracy"],
    levels: [
      {name: "Excellent", desc: "Correct and efficient application with clear procedure and accurate results"},
      {name: "Good", desc: "Mostly correct application with minor procedural issues and mostly accurate results"},
      {name: "Fair", desc: "Basic application with some procedural errors and partially accurate results"},
      {name: "Poor", desc: "Incorrect application with significant procedural errors and inaccurate results"}
    ]
  },
  Analyze: {
    criteria: ["Breakdown", "Relationships", "Insight"],
    levels: [
      {name: "Excellent", desc: "Thorough breakdown with clear relationships and deep insights"},
      {name: "Good", desc: "Good breakdown with identified relationships and some insights"},
      {name: "Fair", desc: "Basic breakdown with some relationships identified and limited insights"},
      {name: "Poor", desc: "Incomplete breakdown with unclear relationships and no insights"}
    ]
  },
  Evaluate: {
    criteria: ["Criteria", "Judgment", "Support"],
    levels: [
      {name: "Excellent", desc: "Clear criteria used with sound judgment and strong supporting evidence"},
      {name: "Good", desc: "Appropriate criteria used with reasonable judgment and some supporting evidence"},
      {name: "Fair", desc: "Basic criteria used with limited judgment and weak supporting evidence"},
      {name: "Poor", desc: "No clear criteria used with poor judgment and no supporting evidence"}
    ]
  },
  Create: {
    criteria: ["Originality", "Feasibility", "Presentation"],
    levels: [
      {name: "Excellent", desc: "Highly original idea that is feasible and well-presented"},
      {name: "Good", desc: "Original idea that is mostly feasible and clearly presented"},
      {name: "Fair", desc: "Somewhat original idea with feasibility issues and unclear presentation"},
      {name: "Poor", desc: "Unoriginal idea that is not feasible and poorly presented"}
    ]
  }
};

/* Default policy (placeholder). Replace via Policy Manager with your PDF details. */
const DEFAULT_POLICY={
  name:"Sindh – SELD defaults (placeholder)",
  grades:{
    "1":{subjects:["English","Urdu/Sindhi","Mathematics","General Knowledge","Islamiat / Ethics"]},
    "2":{subjects:["English","Urdu/Sindhi","Mathematics","General Knowledge","Islamiat / Ethics"]},
    "3":{subjects:["English","Urdu/Sindhi","Mathematics","Science","Social Studies","Islamiat / Ethics"]},
    "4":{subjects:["English","Urdu/Sindhi","Mathematics","Science","Social Studies","Islamiat / Ethics"]},
    "5":{subjects:["English","Urdu/Sindhi","Mathematics","Science","Social Studies","Islamiat / Ethics"]},
    "6":{subjects:["English","Urdu/Sindhi","Mathematics","General Science","Social Studies","Computer Studies","Islamiat / Ethics"]},
    "7":{subjects:["English","Urdu/Sindhi","Mathematics","General Science","Social Studies","Computer Studies","Islamiat / Ethics"]},
    "8":{subjects:["English","Urdu/Sindhi","Mathematics","General Science","Social Studies","Computer Studies","Islamiat / Ethics"]},
    "9":{groups:[
      {id:"science_bio",name:"Science (Biology Group)",subjects:["English","Urdu/Sindhi","Islamiat (IX) / Ethics","Pakistan Studies (X)","Mathematics","Physics","Chemistry","Biology"]},
      {id:"science_cs",name:"Science (Computer Science Group)",subjects:["English","Urdu/Sindhi","Islamiat (IX) / Ethics","Pakistan Studies (X)","Mathematics","Physics","Chemistry","Computer Science"]},
      {id:"general_arts",name:"General (Arts/Humanities)",subjects:["English","Urdu/Sindhi","Islamiat (IX) / Ethics","Pakistan Studies (X)","General Mathematics","General Science","Civics","Economics"]},
      {id:"commerce",name:"Commerce",subjects:["English","Urdu/Sindhi","Islamiat (IX) / Ethics","Pakistan Studies (X)","Principles of Commerce","Principles of Accounting","Business Mathematics","Computer Studies"]}
    ]},
    "10":{groups:[
      {id:"science_bio",name:"Science (Biology Group)",subjects:["English","Urdu/Sindhi","Islamiat (IX) / Ethics","Pakistan Studies (X)","Mathematics","Physics","Chemistry","Biology"]},
      {id:"science_cs",name:"Science (Computer Science Group)",subjects:["English","Urdu/Sindhi","Islamiat (IX) / Ethics","Pakistan Studies (X)","Mathematics","Physics","Chemistry","Computer Science"]},
      {id:"general_arts",name:"General (Arts/Humanities)",subjects:["English","Urdu/Sindhi","Islamiat (IX) / Ethics","Pakistan Studies (X)","General Mathematics","General Science","Civics","Economics"]},
      {id:"commerce",name:"Commerce",subjects:["English","Urdu/Sindhi","Islamiat (IX) / Ethics","Pakistan Studies (X)","Principles of Commerce","Principles of Accounting","Business Mathematics","Computer Studies"]}
    ]}
  }
};
const POLICY_LS_KEY="tos_policy_custom";

/* UI refs */
const app=$("#tosApp");
const gradeSel=$("#gradeSel"), groupWrap=$("#groupWrap"), groupSel=$("#groupSel"), subjectSel=$("#subjectSel");
const marksInp=$("#marksInp"), timeInp=$("#timeInp"), policySel=$("#policySel");
const contentTa=$("#contentTa"), parseBtn=$("#parseBtn"), exBtn=$("#exBtn"), generateQuestionsBtn=$("#generateQuestionsBtn");
const tosWrap=$("#tosWrap"), blueWrap=$("#blueWrap"), tosInfo=$("#tosInfo"), checks=$("#checks");
const printBtn=$("#printBtn"), csvTosBtn=$("#csvTosBtn"), xlsTosBtn=$("#xlsTosBtn"), csvItemsBtn=$("#csvItemsBtn"), generateRubricsBtn=$("#generateRubricsBtn");
const langSel=$("#langSel"), rtlChk=$("#rtlChk");
const loadDefaultsBtn=$("#loadDefaultsBtn"), applyPolicyBtn=$("#applyPolicyBtn"), savePolicyBtn=$("#savePolicyBtn"), exportPolicyBtn=$("#exportPolicyBtn"), importPolicyFile=$("#importPolicyFile"), policyJsonTa=$("#policyJsonTa");

/* Modal refs */
const rubricsModal=$("#rubricsModal"), rubricsContent=$("#rubricsContent"), exportRubricsBtn=$("#exportRubricsBtn"), closeRubricsBtn=$("#closeRubricsBtn");
const questionsModal=$("#questionsModal"), questionsContent=$("#questionsContent"), exportQuestionsBtn=$("#exportQuestionsBtn"), closeQuestionsBtn=$("#closeQuestionsBtn");

/* Dynamic headers */
$("#bloomHead").innerHTML=BLOOM.map(b=>`<th>${b}</th>`).join("");
$("#bloomRow").innerHTML=BLOOM.map(b=>`<td><input type="number" class="num bloomPct" data-b="${b}" min="0" max="100"></td>`).join("");
$("#diffHead").innerHTML=DIFF.map(d=>`<th>${d}</th>`).join("");
$("#diffRow").innerHTML=DIFF.map(d=>`<td><input type="number" class="num diffPct" data-d="${d}" min="0" max="100"></td>`).join("");

const bloomInputs=$$(".bloomPct"), diffInputs=$$(".diffPct");

/* State */
const S={chapters:[],cells:[],items:[],matrix:null,meta:{},policy:loadPolicyFromStorage()||DEFAULT_POLICY};

/* Init */
(function init(){
  // Grade options
  for(let g=1;g<=10;g++){ let opt=CE("option",{value:g,textContent:"Grade "+g}); gradeSel.appendChild(opt); }
  // Policy JSON pane
  policyJsonTa.value=JSON.stringify(S.policy,null,2);

  fillGroupsFromPolicy(); // sets default groups for 9–10
  fillSubjectsFromPolicy();

  gradeSel.addEventListener("change",handleGradeChange);
  groupSel.addEventListener("change",()=>fillSubjectsFromPolicy());
  policySel.addEventListener("change",()=>applyDefaultBloom());
  langSel.addEventListener("change",()=>applyLang());
  rtlChk.addEventListener("change",()=>toggleRTL());
  loadDefaultsBtn.addEventListener("click",()=>{ S.policy=JSON.parse(JSON.stringify(DEFAULT_POLICY)); policyJsonTa.value=JSON.stringify(S.policy,null,2); fillGroupsFromPolicy(); fillSubjectsFromPolicy(); });
  applyPolicyBtn.addEventListener("click",applyPolicyFromJSON);
  savePolicyBtn.addEventListener("click",savePolicyToStorage);
  exportPolicyBtn.addEventListener("click",exportPolicyJSON);
  importPolicyFile.addEventListener("change",importPolicyJSON);

  exBtn.addEventListener("click",()=>{ contentTa.value=`Chapter: Cell Biology
- Topic: Cell Organelles
> Identify nucleus, mitochondria and chloroplasts
> Explain the function of ribosomes
- Topic: Cell Membrane
> Describe diffusion and osmosis with examples
> Compare passive vs active transport

Chapter: Photosynthesis
- Topic: Light Reactions
> Differentiate PSI and PSII
> Justify the role of chlorophyll in light absorption

Chapter: Human Body Systems
- Topic: Circulatory System
> Solve simple pulse-rate problems
> Evaluate lifestyle choices affecting heart health`; });

  parseBtn.addEventListener("click",runAllocation);
  printBtn.addEventListener("click",()=>window.print());
  csvTosBtn.addEventListener("click",exportToS_CSV);
  csvItemsBtn.addEventListener("click",exportItems_CSV);
  xlsTosBtn.addEventListener("click",exportToS_XLS);
  generateRubricsBtn.addEventListener("click",generateRubrics);
  generateQuestionsBtn.addEventListener("click",generateQuestions);

  // Modal events
  closeRubricsBtn.addEventListener("click",()=>rubricsModal.style.display="none");
  $(".modal-close", rubricsModal).addEventListener("click",()=>rubricsModal.style.display="none");
  closeQuestionsBtn.addEventListener("click",()=>questionsModal.style.display="none");
  $(".modal-close", questionsModal).addEventListener("click",()=>questionsModal.style.display="none");
  exportRubricsBtn.addEventListener("click",exportRubrics);
  exportQuestionsBtn.addEventListener("click",exportQuestions);

  applyLang(); toggleRTL();
  applyDefaultBloom(); applyDefaultDiff();
})();

function handleGradeChange(){
  const g=gradeSel.value;
  groupWrap.style.display=(g==="9"||g==="10")?"block":"none";
  fillSubjectsFromPolicy();
  applyDefaultBloom();
}
function getActivePolicy(){ return policySel.value==="custom" ? (loadPolicyFromStorage()||S.policy) : S.policy; }
function fillGroupsFromPolicy(){
  groupSel.innerHTML="";
  const pol=getActivePolicy();
  const g9=pol.grades["9"]?.groups||[];
  g9.forEach(gr=>groupSel.appendChild(CE("option",{value:gr.id,textContent:gr.name})));
}
function fillSubjectsFromPolicy(){
  const pol=getActivePolicy();
  const g=gradeSel.value||"9";
  subjectSel.innerHTML="";
  if(g==="9"||g==="10"){
    const gps=pol.grades[g]?.groups||[];
    if(!gps.length){ subjectSel.appendChild(CE("option",{textContent:"(Add groups in Policy Manager)"})); return; }
    const grpId=groupSel.value || gps[0].id;
    const grp=gps.find(x=>x.id===grpId)||gps[0];
    groupSel.value=grp.id;
    grp.subjects.forEach(s=>subjectSel.appendChild(CE("option",{value:s,textContent:`${s} (${g})`})));
  }else{
    const subs=pol.grades[g]?.subjects||[];
    if(!subs.length){ subjectSel.appendChild(CE("option",{textContent:"(Add subjects in Policy Manager)"})); return; }
    subs.forEach(s=>subjectSel.appendChild(CE("option",{value:s,textContent:s})));
  }
}
function applyPolicyFromJSON(){
  try{
    const obj=JSON.parse(policyJsonTa.value);
    S.policy=obj;
    fillGroupsFromPolicy(); fillSubjectsFromPolicy();
    alert("Policy applied to app.");
  }catch(e){ alert("Invalid JSON. Please fix and try again."); }
}
function savePolicyToStorage(){
  try{
    const obj=JSON.parse(policyJsonTa.value);
    localStorage.setItem(POLICY_LS_KEY,JSON.stringify(obj));
    alert("Policy saved to browser.");
  }catch(e){ alert("Invalid JSON. Not saved."); }
}
function loadPolicyFromStorage(){
  try{
    const s=localStorage.getItem(POLICY_LS_KEY);
    if(!s) return null;
    return JSON.parse(s);
  }catch{return null}
}
function exportPolicyJSON(){
  const blob=new Blob([policyJsonTa.value],{type:"application/json"});
  const a=CE("a",{href:URL.createObjectURL(blob),download:"sindh_policy.json"}); a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}
function importPolicyJSON(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ policyJsonTa.value=r.result; applyPolicyFromJSON(); }; r.readAsText(f);
}

/* Language / RTL */
function applyLang(){ 
  const isUR=langSel.value==="ur";
  app.classList.toggle("rtl",isUR||rtlChk.checked);
}
function toggleRTL(){ app.classList.toggle("rtl",rtlChk.checked); }

/* Inputs normalization */
function normalizeInputs(nodeList,target=100){
  let vals=[...nodeList].map(x=>+x.value||0);
  let sum=vals.reduce((a,b)=>a+b,0);
  if(sum===0){
    const eq=(target/vals.length);
    nodeList.forEach(x=>x.value=Math.round(eq));
    return;
  }
  vals=vals.map(v=>v*target/sum);
  const floors=vals.map(v=>Math.floor(v));
  let assigned=floors.reduce((a,b)=>a+b,0);
  const rem=vals.map((v,i)=>({i,r:v-floors[i]})).sort((a,b)=>b.r-a.r);
  for(let j=0;assigned<target && j<rem.length;j++){ floors[rem[j].i]++; assigned++; }
  nodeList.forEach((n,i)=>n.value=floors[i]);
}
function applyDefaultBloom(){
  const g=+gradeSel.value||9;
  let t;
  if(g<=3) t=STAGE_TARGETS.g1_3;
  else if(g<=6) t=STAGE_TARGETS.g4_6;
  else if(g<=8) t=STAGE_TARGETS.g7_8;
  else t=STAGE_TARGETS.g9_10;
  bloomInputs.forEach(inp=>inp.value=t[inp.dataset.b]??0);
  normalizeInputs(bloomInputs,100);
}
function applyDefaultDiff(){
  diffInputs.forEach(inp=>inp.value=DIFF_DEFAULT[inp.dataset.d]);
  normalizeInputs(diffInputs,100);
}

/* NLP-ish classification */
function classifyBloom(txt){
  const s=(txt||"").toLowerCase();
  const scores=Object.fromEntries(BLOOM.map(b=>[b,0]));
  for(const [b,arr] of Object.entries(RE_VERBS)){
    arr.forEach(r=>{ if(r.test(s)) scores[b]+=1; });
  }
  let max=Math.max(...Object.values(scores));
  if(max===0){
    if(/project|design|create|research|investigate|plan/i.test(s)) return "Create";
    if(/justify|evaluate|critique|assess/i.test(s)) return "Evaluate";
    if(/analy[sz]e|compare|contrast/i.test(s)) return "Analyze";
    if(/apply|solve|calculate|use/i.test(s)) return "Apply";
    if(/explain|describe|summarize|classify/i.test(s)) return "Understand";
    return "Understand";
  }
  const cands=BLOOM.filter(b=>scores[b]===max);
  const order=BLOOM;
  cands.sort((a,b)=>order.indexOf(b)-order.indexOf(a));
  return cands[0];
}
function detectKD(txt,bloom){
  const s=txt||"";
  for(const [k,arr] of Object.entries(KD_HINTS)){ if(arr.some(r=>r.test(s))) return k; }
  if(bloom==="Remember") return "Factual";
  if(bloom==="Understand") return "Conceptual";
  if(bloom==="Apply") return "Procedural";
  if(bloom==="Analyze"||bloom==="Evaluate") return "Conceptual";
  if(bloom==="Create") return "Metacognitive";
  return "Conceptual";
}

/* Parse content lines: Chapter/Topic/Subtopic */
function parseContent(raw){
  const lines=(raw||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const ch=[];
  let curC=null, curT=null;
  for(const ln of lines){
    if(/^((chapter|ch|ž©ž¦ž©)\s*[:\-])/i.test(ln)){
      const name=ln.replace(/^((chapter|ch|ž©ž¦ž©)\s*[:\-])\s*/i,"");
      curC={name,topics:[],weight:0}; ch.push(curC); curT=null;
    }else if(/^(\-|\u2022|topic|┘ģ┘łžČ┘łž╣)\s*[:\-]?/i.test(ln)){
      const name=ln.replace(/^(\-|\u2022|topic|┘ģ┘łžČ┘łž╣)\s*[:\-]?\s*/i,"");
      if(!curC){ curC={name:"Chapter 1",topics:[],weight:0}; ch.push(curC); }
      curT={name,subs:[]}; curC.topics.push(curT);
    }else if(/^(>+|subtopic|slo|learning outcome)/i.test(ln) || ln.startsWith(">") || ln.startsWith("—") || ln.startsWith("–")){
      const txt=ln.replace(/^(>+|subtopic|slo|learning outcome)\s*[:\-]?\s*/i,"").replace(/^[>\-\u2014\u2013]\s*/,"");
      if(!curT){ if(!curC){ curC={name:"Chapter 1",topics:[],weight:0}; ch.push(curC); } curT={name:"Topic",subs:[]}; curC.topics.push(curT); }
      curT.subs.push({text:txt});
    }else{
      if(!curC){ curC={name:"Chapter 1",topics:[],weight:0}; ch.push(curC); }
      curT={name:ln,subs:[]}; curC.topics.push(curT);
    }
  }
  ch.forEach(C=>{
    if(!C.topics.length) C.topics=[{name:"Topic",subs:[{text:C.name}]}];
    C.weight = C.topics.reduce((a,t)=>a+(t.subs?.length||1),0);
  });
  return ch;
}

/* Targets from UI */
function getBloomTargetsFromUI(){
  const obj={}; $$(".bloomPct").forEach(x=>obj[x.dataset.b]=+x.value||0);
  const sum=Object.values(obj).reduce((a,b)=>a+b,0)||1;
  for(const k in obj) obj[k]=obj[k]/sum;
  return obj;
}
function getDiffTargetsFromUI(){
  const o={}; $$(".diffPct").forEach(x=>o[x.dataset.d]=+x.value||0);
  const s=Object.values(o).reduce((a,b)=>a+b,0)||1;
  for(const k in o) o[k]=o[k]/s;
  return o;
}

/* Allocation Engine */
function allocate(chapters,totalMarks,totalTime){
  chapters.forEach(C=>{
    C.topics.forEach(T=>{
      T.subs=T.subs&&T.subs.length?T.subs:[{text:T.name}];
      T.subs.forEach(SU=>{
        const b=classifyBloom(SU.text||"");
        SU.bloom=b; SU.kd=detectKD(SU.text||"",b);
      });
    });
  });

  const chWeights=chapters.map(C=>C.topics.reduce((a,t)=>a+(t.subs?.length||1),0));
  const wSum=chWeights.reduce((a,b)=>a+b,0)||1;
  const wNorm=chWeights.map(w=>w/wSum);

  const bt=getBloomTargetsFromUI();
  const marksByB=BLOOM.map(b=>totalMarks*bt[b]);

  const quotas=[];
  chapters.forEach((C,ci)=>{
    BLOOM.forEach((b,bi)=>{
      quotas.push({ci,bi,val:wNorm[ci]*marksByB[bi]});
    });
  });
  const floors=quotas.map(q=>Math.floor(q.val));
  let assigned=floors.reduce((a,b)=>a+b,0);
  const rem=quotas.map((q,i)=>({i,r:q.val-floors[i]})).sort((a,b)=>b.r-a.r);
  for(let k=0; assigned<totalMarks && k<rem.length; k++){ floors[rem[k].i]++; assigned++; }

  const M=chapters.map(()=>BLOOM.map(()=>0));
  floors.forEach((v,i)=>{ const q=quotas[i]; M[q.ci][q.bi]+=v; });

  const cellItems=chapters.map(()=>BLOOM.map(()=>[]));
  for(let ci=0;ci<chapters.length;ci++){
    for(let bi=0;bi<BLOOM.length;bi++){
      const marks=M[ci][bi];
      const b=BLOOM[bi];
      cellItems[ci][bi]=itemsForCell(marks,b);
    }
  }

  let items=[];
  for(let ci=0;ci<chapters.length;ci++){
    for(let bi=0;bi<BLOOM.length;bi++){
      cellItems[ci][bi].forEach(it=>{ it.chapter=chapters[ci].name; it.bloom=BLOOM[bi]; });
      items=items.concat(cellItems[ci][bi]);
    }
  }

  items=assignDifficulty(items,getDiffTargetsFromUI());

  const totalMarksOut=items.reduce((a,b)=>a+b.marks,0);
  const totalTimeOut=items.reduce((a,b)=>a+b.time,0);
  const matrixCounts=chapters.map(()=>BLOOM.map(()=>0));
  cellItems.forEach((row,ci)=>{ row.forEach((arr,bi)=>{ matrixCounts[ci][bi]=arr.length; }); });

  return {cellMarks:M,cellCounts:matrixCounts,items,totalMarksOut,totalTimeOut};
}

function itemsForCell(marks,bloom){
  if(marks<=0) return [];
  const mix=MIX_BY_BLOOM[bloom];
  const candidates=Object.keys(ITEM_TYPES).filter(t=>mix[t]>0);
  candidates.sort((a,b)=>ITEM_TYPES[b].marks-ITEM_TYPES[a].marks);
  let rem=marks, bag=[];
  const targetMarks=Object.fromEntries(candidates.map(t=>[t,marks*mix[t]]));
  let wish=Object.fromEntries(candidates.map(t=>[t,Math.floor(targetMarks[t]/ITEM_TYPES[t].marks)]));
  for(const t of candidates){
    const per=ITEM_TYPES[t].marks;
    let c=wish[t];
    while(c>0 && rem>=per){ bag.push(makeItem(t)); rem-=per; c--; }
  }
  while(rem>0){
    let pick=candidates.find(t=>ITEM_TYPES[t].marks<=rem);
    if(!pick) pick=candidates[candidates.length-1];
    bag.push(makeItem(pick));
    rem-=ITEM_TYPES[pick].marks;
    if(bag.length>200) break;
  }
  let sum=bag.reduce((a,b)=>a+b.marks,0);
  let guard=0;
  while(sum!==marks && guard<100){
    if(sum>marks){ bag.sort((a,b)=>a.marks-b.marks); const rm=bag.shift(); sum-=rm.marks; }
    else { const t=candidates[candidates.length-1]; bag.push(makeItem(t)); sum+=ITEM_TYPES[t].marks; }
    guard++;
  }
  return bag;
}
function makeItem(type){
  const spec=ITEM_TYPES[type];
  return {type,marks:spec.marks,time:spec.time,diff:"Moderate"};
}
function assignDifficulty(items,diffT){
  items.forEach(it=>{
    if(it.bloom==="Remember"||it.bloom==="Understand") it.diff="Easy";
    else if(it.bloom==="Apply"||it.bloom==="Analyze") it.diff="Moderate";
    else it.diff="Hard";
  });
  const total=items.length||1;
  const want={Easy:Math.round(total*diffT.Easy),Moderate:Math.round(total*diffT.Moderate),Hard:Math.round(total*diffT.Hard)};
  const have=countBy(items.map(i=>i.diff));
  function flip(from,to,need){ for(const it of items){ if(need<=0) break; if(it.diff===from){ it.diff=to; need--; } } }
  if(have.Hard>want.Hard) flip("Hard","Moderate",have.Hard-want.Hard);
  Object.assign(have,countBy(items.map(i=>i.diff)));
  if(have.Easy>want.Easy) flip("Easy","Moderate",have.Easy-want.Easy);
  Object.assign(have,countBy(items.map(i=>i.diff)));
  if(have.Moderate<want.Moderate){ let need=want.Moderate-have.Moderate; flip("Easy","Moderate",Math.ceil(need/2)); flip("Hard","Moderate",Math.floor(need/2)); }
  return items;
}
function countBy(arr){ const m={Easy:0,Moderate:0,Hard:0}; arr.forEach(x=>m[x]=(m[x]||0)+1); return m; }

/* Renderers */
function renderToS(chapters,result){
  const {cellCounts,cellMarks,totalMarksOut,totalTimeOut,items}=result;
  const thead=`<thead><tr><th>Chapter</th>${BLOOM.map(b=>`<th>${b}<br><small>#items</small></th>`).join("")}<th>Total Items</th><th>Total Marks</th></tr></thead>`;
  let rows="";
  for(let ci=0;ci<chapters.length;ci++){
    const c=chapters[ci];
    const counts=cellCounts[ci];
    const rowItems=counts.reduce((a,b)=>a+b,0);
    const rowMarks=cellMarks[ci].reduce((a,b)=>a+b,0);
    rows+=`<tr><td style="text-align:left">${safe(c.name)}</td>${counts.map(n=>`<td>${n}</td>`).join("")}<td><b>${rowItems}</b></td><td><b>${rowMarks}</b></td></tr>`;
  }
  const colTotals=BLOOM.map((_,bi)=>cellCounts.reduce((a,row)=>a+row[bi],0));
  const colMarks=BLOOM.map((_,bi)=>cellMarks.reduce((a,row)=>a+row[bi],0));
  const totalItems=colTotals.reduce((a,b)=>a+b,0);
  rows+=`<tr><th>Total</th>${colTotals.map(n=>`<th>${n}</th>`).join("")}<th>${totalItems}</th><th>${colMarks.reduce((a,b)=>a+b,0)}</th></tr>`;
  tosWrap.innerHTML=`<table>${thead}<tbody>${rows}</tbody></table>`;

  const diff=countBy(items.map(i=>i.diff));
  const byType=items.reduce((m,i)=>((m[i.type]=(m[i.type]||0)+1),m),{});
  tosInfo.innerHTML=`
    <div class="flex" style="flex-wrap:wrap;gap:12px">
      <span class="badge">Total Items: ${totalItems}</span>
      <span class="badge">Marks: ${totalMarksOut}</span>
      <span class="badge">Time: ${Math.round(totalTimeOut)} min</span>
      <span class="badge">Difficulty E/M/H: ${diff.Easy||0}/${diff.Moderate||0}/${diff.Hard||0}</span>
      <span class="badge">Types: ${Object.entries(byType).map(([k,v])=>`${k}:${v}`).join(", ")}</span>
    </div>
  `;
}
function renderItems(items){
  if(!items.length){ blueWrap.innerHTML=""; return;}
  const thead=`<thead><tr><th>#</th><th>Chapter</th><th>Bloom</th><th>Type</th><th>Marks</th><th>Time (min)</th><th>Difficulty</th><th>Knowledge</th><th>Stem Hint</th></tr></thead>`;
  const rows=items.map((it,i)=>{
    const hint=stemHint(it);
    return `<tr>
      <td>${i+1}</td><td style="text-align:left">${safe(it.chapter)}</td><td>${it.bloom||""}</td>
      <td>${it.type}</td><td>${it.marks}</td><td>${it.time}</td><td>${it.diff}</td><td>${it.kd||""}</td>
      <td style="text-align:left">${safe(hint)}</td>
    </tr>`;
  }).join("");
  blueWrap.innerHTML=`<table>${thead}<tbody>${rows}</tbody></table>`;
}
function stemHint(it){
  const b=it.bloom;
  if(b==="Remember") return "Define / Identify / List...";
  if(b==="Understand") return "Explain / Describe / Summarize...";
  if(b==="Apply") return "Solve / Use rule in context...";
  if(b==="Analyze") return "Compare / Differentiate / Interpret data...";
  if(b==="Evaluate") return "Justify / Critique with reasons...";
  if(b==="Create") return "Design / Develop / Plan a solution...";
  return "";
}
function safe(s){ return String(s||"").replace(/[<>&]/g,m=>({"<":"&lt;",">":"&gt;","&":"&amp;"}[m])); }

/* Coverage checks */
function renderChecks(chapters,result,totalMarks,allocBloomTargets){
  const {cellCounts,cellMarks}=result;
  const byBloom=BLOOM.map((b,bi)=>cellMarks.reduce((a,row)=>a+row[bi],0));
  const sumMarks=byBloom.reduce((a,b)=>a+b,0)||1;
  const pct=byBloom.map(m=>Math.round(100*m/sumMarks));
  const tgt=BLOOM.map(b=>Math.round(100*allocBloomTargets[b]));
  let msgs=[];
  BLOOM.forEach((b,i)=>{ if(Math.abs(pct[i]-tgt[i])>3) msgs.push(`${b}: ${pct[i]}% vs target ${tgt[i]}%`); });
  chapters.forEach((c,ci)=>{
    const row=cellCounts[ci];
    const covered=row.reduce((a,b)=>a+(b>0?1:0),0);
    if(covered<Math.min(3,BLOOM.length)) msgs.push(`Low Bloom spread in "${c.name}" (${covered}/${BLOOM.length})`);
  });
  checks.innerHTML=msgs.length
    ? `<ul style="margin:6px 0 0 20px">${msgs.map(m=>`<li class="warnTxt">${safe(m)}</li>`).join("")}</ul>`
    : `<span class="okTxt">All coverage checks within tolerance.</span>`;
}

/* Exporters */
function tableToCSV(tbl){
  const rows=[...tbl.querySelectorAll("tr")];
  return rows.map(tr=>[...tr.children].map(td=>`"${td.textContent.replace(/"/g,'""')}"`).join(",")).join("\n");
}
function download(name,blob){ const a=CE("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }
function exportToS_CSV(){ const tbl=tosWrap.querySelector("table"); if(!tbl) return; const csv=tableToCSV(tbl); download("ToS.csv",new Blob([csv],{type:"text/csv"})); }
function exportItems_CSV(){ const tbl=blueWrap.querySelector("table"); if(!tbl) return; const csv=tableToCSV(tbl); download("Items.csv",new Blob([csv],{type:"text/csv"})); }
function exportToS_XLS(){
  const tbl=tosWrap.querySelector("table"); if(!tbl) return;
  const html=`<html><head><meta charset="UTF-8"></head><body>${tbl.outerHTML}</body></html>`;
  const blob=new Blob([html],{type:"application/vnd.ms-excel"}); download("ToS.xls",blob);
}

/* New Features */
function generateRubrics() {
  if (!S.items || S.items.length === 0) {
    alert("Please generate items first by clicking 'Auto Classify + Allocate'");
    return;
  }

  // Group items by Bloom level
  const itemsByBloom = S.items.reduce((acc, item) => {
    if (!acc[item.bloom]) acc[item.bloom] = [];
    acc[item.bloom].push(item);
    return acc;
  }, {});

  let rubricsHTML = '<h3>Assessment Rubrics</h3>';

  // Create rubrics for each Bloom level present
  Object.entries(itemsByBloom).forEach(([bloom, items]) => {
    const rubric = RUBRIC_TEMPLATES[bloom];
    if (!rubric) return;

    rubricsHTML += `
      <div class="rubric-item">
        <h4>${bloom} Level Questions</h4>
        <p>Applies to ${items.length} items (${items.filter(i=>i.type==='MCQ').length} MCQs, ${items.filter(i=>i.type==='Short').length} Short, ${items.filter(i=>i.type==='Structured').length} Structured, ${items.filter(i=>i.type==='Extended').length} Extended)</p>
        <div class="rubric-levels">
          ${rubric.levels.map(level => `
            <div class="rubric-level">
              <h4>${level.name}</h4>
              <p>${level.desc}</p>
            </div>
          `).join('')}
        </div>
        <p><strong>Criteria:</strong> ${rubric.criteria.join(', ')}</p>
      </div>
    `;
  });

  rubricsContent.innerHTML = rubricsHTML;
  rubricsModal.style.display = "flex";
}

function exportRubrics() {
  const blob = new Blob([rubricsContent.innerText], {type: "text/plain"});
  download("rubrics.txt", blob);
}

function generateQuestions() {
  const chapters = parseContent(contentTa.value);
  if (chapters.length === 0) {
    alert("Please enter content (chapters, topics, subtopics) first");
    return;
  }

  let questionsHTML = '<h3>Generated Questions</h3>';
  
  chapters.forEach(chapter => {
    questionsHTML += `<h4>Chapter: ${chapter.name}</h4>`;
    
    chapter.topics.forEach(topic => {
      questionsHTML += `<h5>Topic: ${topic.name}</h5>`;
      
      // Generate questions for each subtopic
      topic.subs.forEach((sub, i) => {
        const bloom = classifyBloom(sub.text);
        const templates = QUESTION_TEMPLATES[bloom] || QUESTION_TEMPLATES['Understand'];
        const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
        
        // Replace placeholders in template
        let question = randomTemplate.replace('{topic}', topic.name);
        if (question.includes('{relatedTopic}')) {
          // Find a different topic from the same chapter to use as related topic
          const otherTopics = chapter.topics.filter(t => t.name !== topic.name);
          const relatedTopic = otherTopics.length > 0 
            ? otherTopics[Math.floor(Math.random() * otherTopics.length)].name 
            : 'a related concept';
          question = question.replace('{relatedTopic}', relatedTopic);
        }
        
        questionsHTML += `
          <div class="rubric-item">
            <p><strong>Question ${i+1}:</strong> ${question}</p>
            <p><small>Bloom Level: ${bloom} | Based on: "${sub.text}"</small></p>
          </div>
        `;
      });
    });
  });

  questionsContent.innerHTML = questionsHTML;
  questionsModal.style.display = "flex";
}

function exportQuestions() {
  const blob = new Blob([questionsContent.innerText], {type: "text/plain"});
  download("questions.txt", blob);
}

/* Run */
function runAllocation(){
  const chapters=parseContent(contentTa.value);
  chapters.forEach(C=>C.topics.forEach(T=>T.subs.forEach(SU=>{ SU.bloom=classifyBloom(SU.text); SU.kd=detectKD(SU.text,SU.bloom); })));
  const totalMarks=+marksInp.value||50, totalTime=+timeInp.value||60;
  const result=allocate(chapters,totalMarks,totalTime);
  result.items.forEach(it=>{
    if(!it.kd) it.kd = (it.bloom==="Remember"?"Factual":it.bloom==="Apply"?"Procedural":it.bloom==="Create"?"Metacognitive":"Conceptual");
  });
  S.items = result.items; // Store items for rubrics generation
  renderToS(chapters,result);
  renderItems(result.items);
  renderChecks(chapters,result,totalMarks,getBloomTargetsFromUI());
  window.scrollTo({top:app.offsetTop+app.offsetHeight,behavior:"smooth"});
}
</script>
</body>
</html>